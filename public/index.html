<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maintenance Ticketing System</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <link rel="icon" href="/favicon.ico">
</head>
<body class="bg-gray-100">
    <div id="login-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded shadow-lg">
            <h2 class="text-lg font-bold mb-4">Login</h2>
            <input id="login-email" type="email" placeholder="Email" class="border p-2 mb-2 w-full">
            <input id="login-password" type="password" placeholder="Password" class="border p-2 mb-2 w-full">
            <button onclick="login()" class="bg-blue-500 text-white px-4 py-2 rounded">Login</button>
        </div>
    </div>

    <div id="dashboard" class="container mx-auto p-4 hidden">
        <h1 class="text-2xl font-bold mb-4">Maintenance Dashboard</h1>
        <div class="flex justify-between mb-4">
            <div>
                <button onclick="showScreen('submit-ticket')" class="bg-blue-500 text-white px-4 py-2 rounded mr-2">Submit Ticket</button>
                <button onclick="showScreen('all-tickets')" class="bg-blue-500 text-white px-4 py-2 rounded mr-2">All Tickets</button>
                <button onclick="showScreen('analytics')" class="bg-blue-500 text-white px-4 py-2 rounded">Analytics</button>
            </div>
            <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded">Logout</button>
        </div>
        <div id="manager-controls" class="mb-4 hidden">
            <button id="test-alarm" onclick="testAlarm()" class="bg-green-500 text-white px-4 py-2 rounded">Test Alarm</button>
        </div>
        <div class="grid grid-cols-3 gap-4 mb-4">
            <div id="MRR" class="p-4 border rounded"><h2 class="font-bold">MRR</h2><p id="MRR-tickets">0 open, 0 ongoing</p></div>
            <div id="FCM" class="p-4 border rounded"><h2 class="font-bold">FCM</h2><p id="FCM-tickets">0 open, 0 ongoing</p></div>
            <div id="IAMM" class="p-4 border rounded"><h2 class="font-bold">IAMM</h2><p id="IAMM-tickets">0 open, 0 ongoing</p></div>
        </div>
        <p id="tickets-today" class="mb-4">Tickets generated today: 0</p>
        <table class="w-full border">
            <thead>
                <tr><th class="border p-2">Line</th><th class="border p-2">Downtime (minutes)</th></tr>
            </thead>
            <tbody id="downtime-table"></tbody>
        </table>
    </div>

    <div id="submit-ticket" class="container mx-auto p-4 hidden">
        <h1 class="text-2xl font-bold mb-4">Submit Ticket</h1>
        <div class="mb-4">
            <input id="employee-id" type="text" placeholder="Employee ID" class="border p-2 mr-2">
            <input id="name" type="text" placeholder="Name" class="border p-2 mr-2">
            <select id="line" class="border p-2 mr-2">
                <option value="">Select Line</option>
                <option value="MRR">MRR</option>
                <option value="FCM">FCM</option>
                <option value="IAMM">IAMM</option>
            </select>
            <select id="operation" class="border p-2 mr-2">
                <option value="">Select Operation</option>
            </select>
            <textarea id="description" placeholder="Description" class="border p-2 w-full"></textarea>
            <button onclick="submitTicket()" class="bg-blue-500 text-white px-4 py-2 rounded mt-2">Submit</button>
        </div>
        <button onclick="showScreen('dashboard')" class="bg-gray-500 text-white px-4 py-2 rounded">Back</button>
    </div>

    <div id="all-tickets" class="container mx-auto p-4 hidden">
        <h1 class="text-2xl font-bold mb-4">All Tickets</h1>
        <div class="mb-4">
            <select id="ticket-filter" class="border p-2">
                <option value="">All</option>
                <option value="Open">Open</option>
                <option value="Ongoing">Ongoing</option>
                <option value="Closed">Closed</option>
            </select>
            <button onclick="filterTickets()" class="bg-blue-500 text-white px-4 py-2 rounded">Filter</button>
        </div>
        <table class="w-full border">
            <thead>
                <tr><th class="border p-2">Ticket ID</th><th class="border p-2">Line</th><th class="border p-2">Process</th><th class="border p-2">Description</th><th class="border p-2">Status</th><th class="border p-2">Actions</th></tr>
            </thead>
            <tbody id="tickets-table"></tbody>
        </table>
        <button onclick="showScreen('dashboard')" class="bg-gray-500 text-white px-4 py-2 rounded mt-4">Back</button>
    </div>

    <div id="analytics" class="container mx-auto p-4 hidden">
        <h1 class="text-2xl font-bold mb-4">Analytics</h1>
        <div class="mb-4">
            <select id="analytics-line" class="border p-2 mr-2">
                <option value="">All Lines</option>
                <option value="MRR">MRR</option>
                <option value="FCM">FCM</option>
                <option value="IAMM">IAMM</option>
            </select>
            <select id="analytics-type" class="border p-2 mr-2">
                <option value="downtime">Downtime per Line</option>
                <option value="tickets-by-process">Tickets per Process</option>
            </select>
            <input id="from-date" type="date" class="border p-2 mr-2" placeholder="From">
            <input id="to-date" type="date" class="border p-2 mr-2" placeholder="To">
            <button onclick="updateAnalytics()" class="bg-blue-500 text-white px-4 py-2 rounded">Update</button>
        </div>
        <div class="w-full max-w-lg">
            <canvas id="analytics-chart" style="max-height: 300px;"></canvas>
        </div>
        <div class="mt-4">
            <h2 class="text-xl font-bold mb-2">Technician Performance</h2>
            <table class="w-full border">
                <thead>
                    <tr>
                        <th class="border p-2">Technician</th>
                        <th class="border p-2">Tickets Resolved</th>
                        <th class="border p-2">Total Resolve Time (minutes)</th>
                        <th class="border p-2">Total Downtime (minutes)</th>
                    </tr>
                </thead>
                <tbody id="technician-table"></tbody>
            </table>
        </div>
        <button onclick="showScreen('dashboard')" class="bg-gray-500 text-white px-4 py-2 rounded mt-4">Back</button>
    </div>

    <script>
        let accessToken = localStorage.getItem('accessToken') || null;
        let currentUser = null;
        const audio = new Audio('/beep-01a.mp3');
        let isTestAlarmPlaying = false;

        const processes = {
            MRR: ['Magazine Loader', 'ICT', 'HOT CHAMBER'],
            FCM: ['Process A', 'Process B', 'Process C'],
            IAMM: ['Process X', 'Process Y', 'Process Z']
        };

        async function init() {
            if (accessToken) {
                try {
                    const response = await fetch('/api/user', {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    if (response.ok) {
                        const { role } = await response.json();
                        currentUser = { role };
                    }
                } catch (error) {
                    console.error('Error initializing:', error);
                }
            }
            updateUIForRole();
            showScreen('dashboard');
            updateDashboard();
            setInterval(checkAlarms, 30000);
        }

        function showModal(modalId) {
            console.log('showModal called with:', modalId);
            document.getElementById(modalId).classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function showScreen(screenId) {
            document.querySelectorAll('.container').forEach(container => container.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
            if (screenId === 'dashboard') updateDashboard();
            if (screenId === 'all-tickets') updateTicketsTable();
            if (screenId === 'submit-ticket') updateOperationOptions();
            if (screenId === 'analytics') updateAnalytics();
        }

        function updateUIForRole() {
            if (!currentUser) {
                showModal('login-modal');
                document.getElementById('manager-controls').classList.add('hidden');
            } else {
                closeModal('login-modal');
                document.getElementById('manager-controls').classList.toggle('hidden', currentUser.role !== 'Manager');
            }
        }

        async function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            if (!email || !password) {
                alert('Please enter email and password');
                return;
            }
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const { access_token, role } = await response.json();
                accessToken = access_token;
                localStorage.setItem('accessToken', accessToken);
                currentUser = { role };
                updateUIForRole();
                closeModal('login-modal');
                showScreen('dashboard');
            } catch (error) {
                console.error('Error logging in:', error);
                alert(`Failed to login: ${error.message}`);
            }
        }

        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                accessToken = null;
                localStorage.removeItem('accessToken');
                currentUser = null;
                updateUIForRole();
            } catch (error) {
                console.error('Error logging out:', error);
            }
        }

        async function updateDashboard() {
            try {
                const ticketsResponse = await fetch('/api/tickets?status=Open,Ongoing', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const tickets = await ticketsResponse.json();
                const lines = ['MRR', 'FCM', 'IAMM'];
                lines.forEach(line => {
                    const open = tickets.filter(t => t.line === line && t.status === 'Open').length;
                    const ongoing = tickets.filter(t => t.line === line && t.status === 'Ongoing').length;
                    const div = document.getElementById(line);
                    div.className = `p-4 border rounded ${open > 0 ? 'bg-red-200' : ongoing > 0 ? 'bg-yellow-200' : 'bg-green-200'}`;
                    document.getElementById(`${line}-tickets`).textContent = `${open} open, ${ongoing} ongoing`;
                });

                const statsResponse = await fetch('/api/ticket-stats', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const stats = await statsResponse.json();
                document.getElementById('tickets-today').textContent = `Tickets generated today: ${stats.today}`;

                const downtimeResponse = await fetch('/api/downtime', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const downtime = await downtimeResponse.json();
                const tbody = document.getElementById('downtime-table');
                tbody.innerHTML = '';
                downtime.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td class="border p-2">${item.line}</td><td class="border p-2">${item.downtime}</td>`;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Error updating dashboard:', error);
            }
        }

        function updateOperationOptions() {
            const line = document.getElementById('line').value;
            const operationSelect = document.getElementById('operation');
            operationSelect.innerHTML = '<option value="">Select Operation</option>';
            if (line && processes[line]) {
                processes[line].forEach(process => {
                    const option = document.createElement('option');
                    option.value = process;
                    option.textContent = process;
                    operationSelect.appendChild(option);
                });
            }
        }

        async function submitTicket() {
            const employeeId = document.getElementById('employee-id').value;
            const name = document.getElementById('name').value;
            const line = document.getElementById('line').value;
            const process = document.getElementById('operation').value;
            const description = document.getElementById('description').value;

            if (!employeeId || !name || !line || !process || !description) {
                alert('Please enter all fields');
                return;
            }

            try {
                const response = await fetch('/api/tickets', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({ employee_id: employeeId, name, line, process, description, status: 'Open' })
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                document.getElementById('employee-id').value = '';
                document.getElementById('name').value = '';
                document.getElementById('line').value = '';
                document.getElementById('operation').innerHTML = '<option value="">Select Operation</option>';
                document.getElementById('description').value = '';
                alert('Ticket submitted successfully');
                showScreen('dashboard');
            } catch (error) {
                console.error('Error submitting ticket:', error);
                alert(`Failed to submit ticket: ${error.message}`);
            }
        }

        async function updateTicketsTable() {
            const filter = document.getElementById('ticket-filter').value;
            let url = '/api/tickets';
            if (filter) url += `?status=${filter}`;
            try {
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const tickets = await response.json();
                const tbody = document.getElementById('tickets-table');
                tbody.innerHTML = '';
                tickets.forEach(ticket => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="border p-2">${ticket.ticket_id}</td>
                        <td class="border p-2">${ticket.line}</td>
                        <td class="border p-2">${ticket.process}</td>
                        <td class="border p-2">${ticket.description}</td>
                        <td class="border p-2">${ticket.status}</td>
                        <td class="border p-2">
                            ${currentUser?.role === 'Manager' && ticket.status === 'Open' ? `<button onclick="assignTicket('${ticket.ticket_id}')" class="bg-blue-500 text-white px-2 py-1 rounded">Assign</button>` : ''}
                            ${currentUser?.role === 'Manager' && ticket.status === 'Ongoing' ? `<button onclick="resolveTicket('${ticket.ticket_id}')" class="bg-green-500 text-white px-2 py-1 rounded">Resolve</button>` : ''}
                        </td>`;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Error updating tickets:', error);
            }
        }

        async function filterTickets() {
            updateTicketsTable();
        }

        async function assignTicket(ticketId) {
            const assignedTo = prompt('Enter assignee email:');
            if (!assignedTo) return;
            try {
                const response = await fetch(`/api/tickets/${ticketId}/assign`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({ assigned_to: assignedTo, status: 'Ongoing', assigned_at: new Date().toISOString() })
                });
                if (!response.ok) throw new Error('Failed to assign ticket');
                updateTicketsTable();
            } catch (error) {
                console.error('Error assigning ticket:', error);
                alert('Failed to assign ticket');
            }
        }

        async function resolveTicket(ticketId) {
            const issue = prompt('Enter issue:');
            const fix = prompt('Enter fix:');
            if (!issue || !fix) return;
            try {
                const response = await fetch(`/api/tickets/${ticketId}/resolve`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({ issue, fix, status: 'Closed', resolved_by: currentUser.email, resolved_at: new Date().toISOString() })
                });
                if (!response.ok) throw new Error('Failed to resolve ticket');
                updateTicketsTable();
            } catch (error) {
                console.error('Error resolving ticket:', error);
                alert('Failed to resolve ticket');
            }
        }

        async function checkAlarms() {
            try {
                const response = await fetch('/api/tickets?status=Open', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                if (!response.ok) throw new Error('Failed to fetch tickets');
                const tickets = await response.json();
                const now = new Date();
                let alarmTriggered = false;
                tickets.forEach(ticket => {
                    const createdAt = new Date(ticket.created_at);
                    if ((now - createdAt) / (1000 * 60) > 3) {
                        alarmTriggered = true;
                    }
                });
                if (alarmTriggered && audio.paused && !isTestAlarmPlaying) {
                    audio.loop = true;
                    audio.play().catch(error => console.error('Audio play error:', error));
                } else if (!alarmTriggered && !audio.paused && !isTestAlarmPlaying) {
                    audio.pause();
                    audio.currentTime = 0;
                }
            } catch (error) {
                console.error('Error checking alarms:', error);
            }
        }

        function testAlarm() {
            if (isTestAlarmPlaying) {
                audio.pause();
                audio.currentTime = 0;
                isTestAlarmPlaying = false;
                document.getElementById('test-alarm').textContent = 'Test Alarm';
            } else {
                audio.loop = true;
                audio.play().catch(error => console.error('Audio play error:', error));
                isTestAlarmPlaying = true;
                document.getElementById('test-alarm').textContent = 'Stop Alarm';
            }
        }

        async function updateAnalytics() {
            const line = document.getElementById('analytics-line').value;
            const type = document.getElementById('analytics-type').value;
            const fromDate = document.getElementById('from-date').value;
            const toDate = document.getElementById('to-date').value;
            let url = type === 'downtime' ? '/api/downtime' : '/api/tickets-by-process';
            if (line || fromDate || toDate) {
                url += '?';
                if (line) url += `line=${line}&`;
                if (fromDate) url += `from=${fromDate}&`;
                if (toDate) url += `to=${toDate}&`;
                url = url.slice(0, -1);
            }
            try {
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                let data = await response.json();
                console.log('Analytics data:', data); // Debug
                if (type === 'tickets-by-process') {
                    data = data.sort((a, b) => b.count - a.count || a.process.localeCompare(b.process));
                }
                updateAnalyticsChart(data, type);
                updateTechnicianTable();
            } catch (error) {
                console.error('Error updating analytics:', error);
            }
        }

        function updateAnalyticsChart(data, type) {
            const ctx = document.getElementById('analytics-chart').getContext('2d');
            if (window.analyticsChart) window.analyticsChart.destroy();
            window.analyticsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.length ? data.map(item => item.line || item.process) : ['No Data'],
                    datasets: [{
                        label: type === 'downtime' ? 'Downtime (minutes)' : 'Created Tickets',
                        data: data.length ? data.map(item => item.downtime || item.count) : [0],
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        async function updateTechnicianTable() {
            const line = document.getElementById('analytics-line').value;
            const fromDate = document.getElementById('from-date').value;
            const toDate = document.getElementById('to-date').value;
            let url = '/api/technician-stats';
            if (line || fromDate || toDate) {
                url += '?';
                if (line) url += `line=${line}&`;
                if (fromDate) url += `from=${fromDate}&`;
                if (toDate) url += `to=${toDate}&`;
                url = url.slice(0, -1);
            }
            try {
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                console.log('Technician data:', data); // Debug
                const tbody = document.getElementById('technician-table');
                tbody.innerHTML = '';
                data.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="border p-2">${item.technician || 'Unassigned'}</td>
                        <td class="border p-2">${item.tickets_resolved}</td>
                        <td class="border p-2">${Math.round(item.total_resolve_time)}</td>
                        <td class="border p-2">${Math.round(item.total_downtime)}</td>`;
                    tbody.appendChild(tr);
                });
                if (!data.length) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td class="border p-2" colspan="4">No technician data available</td>`;
                    tbody.appendChild(tr);
                }
            } catch (error) {
                console.error('Error updating technician table:', error);
            }
        }

        init();
    </script>
</body>
</html>