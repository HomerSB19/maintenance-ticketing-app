<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maintenance Ticketing App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <style>
        @keyframes flash-red {
            0%, 100% { background-color: #ef4444; }
            50% { background-color: #dc2626; }
        }
        @keyframes flash-yellow {
            0%, 100% { background-color: #facc15; }
            50% { background-color: #eab308; }
        }
        .flash-red { animation: flash-red 1s infinite; }
        .flash-yellow { animation: flash-yellow 1s infinite; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 50; }
        .modal-content { background: white; margin: 10% auto; padding: 20px; width: 90%; max-width: 500px; border-radius: 0.5rem; max-height: 80vh; overflow-y: auto; }
        .modal-front { z-index: 60; }
        #error-notification { display: none; position: fixed; top: 10px; right: 10px; background: #ef4444; color: white; padding: 10px; border-radius: 0.5rem; z-index: 100; }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <audio id="alarm" loop>
        <source src="/beep-01a.mp3" type="audio/mpeg">
        <source src="https://www.soundjay.com/buttons/beep-01a.mp3" type="audio/mpeg">
    </audio>
    <div id="error-notification"></div>
    <div class="container mx-auto p-4 max-w-3xl">
        <div id="auth-section" class="mb-4 flex justify-between items-center">
    <div class="flex items-center">
        <img src="/logo.png" alt="Klemove Logo" class="h-8 mr-4"> <h1 class="text-2xl font-bold text-gray-800">Maintenance Ticketing App</h1>
    </div>

    <div>
        <span id="user-role" class="text-gray-700 mr-4 text-sm"></span>
        <button id="login-btn" onclick="showLoginModal()" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">Login</button>
        <button id="logout-btn" onclick="logout()" class="hidden px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm">Logout</button>
    </div>
</div>
        <div id="nav-buttons" class="flex flex-wrap gap-2 mb-4">
            <button id="submit-ticket-btn" onclick="showScreen('submit-ticket')" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm hidden">Submit Ticket</button>
            <button id="dashboard-btn" onclick="showScreen('dashboard')" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm hidden">Dashboard</button>
            <button id="all-tickets-btn" onclick="showScreen('all-tickets')" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm hidden">All Tickets</button>
            <button id="analytics-btn" onclick="showScreen('analytics')" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm hidden">Analytics</button>
            <button id="test-alarm-btn" onclick="testAlarm()" class="hidden px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm">Test Alarm</button>
        </div>
        <div id="submit-ticket" class="screen hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Submit a New Ticket</h2>
            <form onsubmit="event.preventDefault(); submitTicket();" class="bg-white p-4 rounded-lg shadow-md">
                <div class="mb-2">
                    <label for="employee-id" class="block text-gray-700 font-medium text-sm">ID de Empleado:</label>
                    <input type="text" id="employee-id" class="mt-1 p-2 w-full border rounded focus:outline-none focus:ring-2 focus:ring-blue-600 text-sm" required>
                </div>
                <div class="mb-2">
                    <label for="name" class="block text-gray-700 font-medium text-sm">Nombre:</label>
                    <input type="text" id="name" class="mt-1 p-2 w-full border rounded focus:outline-none focus:ring-2 focus:ring-blue-600 text-sm" required>
                </div>
                <div class="mb-2">
                    <label for="line" class="block text-gray-700 font-medium text-sm">Línea:</label>
                    <select id="line" onchange="updateOperations()" class="mt-1 p-2 w-full border rounded focus:outline-none focus:ring-2 focus:ring-blue-600 text-sm" required>
                        <option value="">Select Line</option>
                        <option value="MRR">MRR</option>
                        <option value="FCM">FCM</option>
                        <option value="IDB">IDB</option>
                        <option value="MGH">MGH</option>
                        <option value="PPK">PPK</option>
                        <option value="IAMM">IAMM</option>
                    </select>
                </div>
                <div class="mb-2">
                    <label for="operation" class="block text-gray-700 font-medium text-sm">Operación:</label>
                    <select id="operation" class="mt-1 p-2 w-full border rounded focus:outline-none focus:ring-2 focus:ring-blue-600 text-sm" required>
                        <option value="">Select Operation</option>
                    </select>
                </div>
                <div class="mb-2">
                    <label for="description" class="block text-gray-700 font-medium text-sm">Descripción del Problema:</label>
                    <textarea id="description" class="mt-1 p-2 w-full border rounded focus:outline-none focus:ring-2 focus:ring-blue-600 text-sm h-20" required></textarea>
                </div>
                <button type="submit" class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm w-full">Submit Ticket</button>
            </form>
        </div>
        <div id="dashboard" class="screen hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Dashboard</h2>
            <div class="grid grid-cols-3 gap-2 mb-4">
                <div id="fcm-box" class="p-4 rounded-lg shadow-md text-center cursor-pointer" onclick="loadLineTickets('FCM')">
                    <h3 class="text-lg font-bold text-gray-800">FCM</h3>
                    <p class="text-gray-800 text-sm">Open: <span id="fcm-open">0</span></p>
                    <p class="text-gray-800 text-sm">Ongoing: <span id="fcm-ongoing">0</span></p>
                </div>
                <div id="mrr-box" class="p-4 rounded-lg shadow-md text-center cursor-pointer" onclick="loadLineTickets('MRR')">
                    <h3 class="text-lg font-bold text-gray-800">MRR</h3>
                    <p class="text-gray-800 text-sm">Open: <span id="mrr-open">0</span></p>
                    <p class="text-gray-800 text-sm">Ongoing: <span id="mrr-ongoing">0</span></p>
                </div>
                <div id="idb-box" class="p-4 rounded-lg shadow-md text-center cursor-pointer" onclick="loadLineTickets('IDB')">
                    <h3 class="text-lg font-bold text-gray-800">IDB</h3>
                    <p class="text-gray-800 text-sm">Open: <span id="idb-open">0</span></p>
                    <p class="text-gray-800 text-sm">Ongoing: <span id="idb-ongoing">0</span></p>
                </div>
                <div id="mgh-box" class="p-4 rounded-lg shadow-md text-center cursor-pointer" onclick="loadLineTickets('MGH')">
                    <h3 class="text-lg font-bold text-gray-800">MGH</h3>
                    <p class="p-2 text-gray-800 text-sm">Open: <span id="mgh-open">0</span></p>
                    <p class="p-2 text-gray-800 text-sm">Ongoing: <span id="mgh-ongoing">0</span></p>
                </div>
                <div id="ppk-box" class="p-4 rounded-lg shadow-md text-center cursor-pointer" onclick="loadLineTickets('PPK')">
                    <h3 class="text-lg font-bold text-gray-800">PPK</h3>
                    <p class="p-2 text-gray-800 text-sm">Open: <span id="ppk-open">0</span></p>
                    <p class="p-2 text-gray-800 text-sm">Ongoing: <span id="ppk-ongoing">0</span></p>
                </div>
                <div id="iamm-box" class="p-4 rounded-lg shadow-md text-center cursor-pointer" onclick="loadLineTickets('IAMM')">
                    <h3 class="text-lg font-bold text-gray-800">IAMM</h3>
                    <p class="p-2 text-gray-800 text-sm">Open: <span id="iamm-open">0</span></p>
                    <p class="p-2 text-gray-800 text-sm">Ongoing: <span id="iamm-ongoing">0</span></p>
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-4">
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h3 class="text-md font-semibold text-gray-800 mb-2">Tickets Generated Today (8AM - 8AM)</h3>
                    <p class="text-gray-700 text-sm" id="tickets-today">0</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h3 class="text-md font-semibold text-gray-800 mb-2">Tickets Generated This Week</h3>
                    <p class="text-gray-700 text-sm" id="tickets-week">0</p>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-md">
                <h3 class="text-md font-semibold text-gray-800 mb-2">Daily Downtime per Line (8AM - 8AM)</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg text-sm">
                        <thead>
                            <tr class="bg-gray-200">
                                <th class="p-2 text-left text-gray-700">Line</th>
                                <th class="p-2 text-left text-gray-700">Tickets Generated</th>
                                <th class="p-2 text-left text-gray-700">Downtime (Minutes)</th>
                            </tr>
                        </thead>
                        <tbody id="downtime-table"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div id="all-tickets" class="screen hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">All Tickets</h2>
            <div class="mb-4 flex flex-wrap gap-2">
                <div>
                    <label for="filter-ticket-id" class="block text-gray-700 font-medium text-sm">Ticket ID:</label>
                    <input type="text" id="filter-ticket-id" oninput="loadAllTickets()" class="mt-1 p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-600 text-sm">
                </div>
                <div>
                    <label for="filter-employee-id" class="block text-gray-700 font-medium text-sm">Employee ID:</label>
                    <input type="text" id="filter-employee-id" oninput="loadAllTickets()" class="mt-1 p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-600 text-sm">
                </div>
                <div>
                    <label for="filter-line" class="block text-gray-700 font-medium text-sm">Line:</label>
                    <select id="filter-line" onchange="loadAllTickets()" class="mt-1 p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-600 text-sm">
                        <option value="">All</option>
                        <option value="MRR">MRR</option>
                        <option value="FCM">FCM</option>
                        <option value="IDB">IDB</option>
                        <option value="MGH">MGH</option>
                        <option value="PPK">PPK</option>
                        <option value="IAMM">IAMM</option>
                    </select>
                </div>
                <div>
                    <label for="filter-process" class="block text-gray-700 font-medium text-sm">Process:</label>
                    <input type="text" id="filter-process" oninput="loadAllTickets()" class="mt-1 p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-600 text-sm">
                </div>
                <div>
                    <label for="filter-description" class="block text-gray-700 font-medium text-sm">Description:</label>
                    <input type="text" id="filter-description" oninput="loadAllTickets()" class="mt-1 p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-600 text-sm">
                </div>
                <div>
                    <label for="filter-status" class="block text-gray-700 font-medium text-sm">Status:</label>
                    <select id="filter-status" onchange="loadAllTickets()" class="mt-1 p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-600 text-sm">
                        <option value="">All</option>
                        <option value="Open">Open</option>
                        <option value="Ongoing">Ongoing</option>
                        <option value="Closed">Closed</option>
                    </select>
                </div>
                <div>
                    <label for="filter-from-date" class="block text-gray-700 font-medium text-sm">From Date:</label>
                    <input type="date" id="filter-from-date" onchange="loadAllTickets()" class="mt-1 p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-600 text-sm">
                </div>
                <div>
                    <label for="filter-to-date" class="block text-gray-700 font-medium text-sm">To Date:</label>
                    <input type="date" id="filter-to-date" onchange="loadAllTickets()" class="mt-1 p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-600 text-sm">
                </div>
            </div>
            <div class="overflow-y-auto max-h-96">
                <table class="min-w-full bg-white rounded-lg shadow-md text-sm">
                    <thead>
                        <tr class="bg-gray-200">
                            <th class="p-2 text-left text-gray-700">Ticket ID</th>
                            <th class="p-2 text-left text-gray-700">Employee ID</th>
                            <th class="p-2 text-left text-gray-700">Line</th>
                            <th class="p-2 text-left text-gray-700">Process</th>
                            <th class="p-2 text-left text-gray-700">Created At</th>
                            <th class="p-2 text-left text-gray-700">Description</th>
                            <th class="p-2 text-left text-gray-700">Status</th>
                        </tr>
                    </thead>
                    <tbody id="ticket-list"></tbody>
                </table>
            </div>
        </div>
        <div id="analytics" class="screen hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Analytics</h2>
            <div class="mb-4 flex flex-wrap gap-2">
                <div>
                    <label for="analytics-line" class="block text-gray-700 font-medium text-sm">Select Line:</label>
                    <select id="analytics-line" onchange="loadAnalytics()" class="mt-1 p-2 w-40 border rounded focus:outline-none focus:ring-2 focus:ring-blue-600 text-sm">
                        <option value="">Select Line</option>
                        <option value="MRR">MRR</option>
                        <option value="FCM">FCM</option>
                        <option value="IDB">IDB</option>
                        <option value="MGH">MGH</option>
                        <option value="PPK">PPK</option>
                        <option value="IAMM">IAMM</option>
                    </select>
                </div>
                <div>
                    <label for="analytics-type" class="block text-gray-700 font-medium text-sm">Select Chart Type:</label>
                    <select id="analytics-type" onchange="loadAnalytics()" class="mt-1 p-2 w-40 border rounded focus:outline-none focus:ring-2 focus:ring-blue-600 text-sm">
                        <option value="downtime">Downtime per Process</option>
                        <option value="tickets">Tickets per Process</option>
                    </select>
                </div>
                <div>
                    <label for="from-date" class="block text-gray-700 font-medium text-sm">From:</label>
                    <input type="date" id="from-date" onchange="loadAnalytics()" class="mt-1 p-2 w-40 border rounded focus:outline-none focus:ring-2 focus:ring-blue-600 text-sm">
                </div>
                <div>
                    <label for="to-date" class="block text-gray-700 font-medium text-sm">To:</label>
                    <input type="date" id="to-date" onchange="loadAnalytics()" class="mt-1 p-2 w-40 border rounded focus:outline-none focus:ring-2 focus:ring-blue-600 text-sm">
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-md mb-4">
                <canvas id="analytics-chart" height="200"></canvas>
            </div>
            <div class="hidden bg-white p-4 rounded-lg shadow-md max-w-md">
                <h3 class="text-md font-semibold text-gray-800 mb-2">Technician Performance</h3>
                <div class="overflow-x-auto">
                    <table class="w-full bg-white rounded-lg text-xs">
                        <thead>
                            <tr class="bg-gray-200">
                                <th class="p-2 text-left text-gray-700">Technician</th>
                                <th class="p-2 text-left text-gray-700">Resolved</th>
                                <th class="p-2 text-left text-gray-700">Resolve Time</th>
                                <th class="p-2 text-left text-gray-700">Downtime</th>
                            </tr>
                        </thead>
                        <tbody id="technician-table"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div id="login-modal" class="modal modal-front">
            <div class="modal-content">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Login</h2>
                <div class="mb-4">
                    <label for="login-email" class="block text-gray-700 font-medium text-sm">Email:</label>
                    <input type="email" id="login-email" class="mt-1 p-2 w-full border rounded focus:outline-none focus:ring-2 focus:ring-blue-600 text-sm" required>
                </div>
                <div class="mb-4">
                    <label for="login-password" class="block text-gray-700 font-medium text-sm">Password:</label>
                    <input type="password" id="login-password" class="mt-1 p-2 w-full border rounded focus:outline-none focus:ring-2 focus:ring-blue-600 text-sm" required>
                </div>
                <div class="mt-4 flex space-x-2">
                    <button onclick="login()" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">Login</button>
                    <button onclick="closeModal('login-modal')" class="px-3 py-1 bg-gray-600 text-white rounded hover:bg-gray-700 text-sm">Cancel</button>
                </div>
            </div>
        </div>
        <div id="ticket-details-modal" class="modal modal-front">
            <div class="modal-content">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Ticket Details</h2>
                <div id="ticket-details-content" class="text-gray-700 text-sm"></div>
                <button onclick="closeModal('ticket-details-modal')" class="mt-4 px-3 py-1 bg-gray-600 text-white rounded hover:bg-gray-700 text-sm">Close</button>
            </div>
        </div>
        <div id="assign-ticket-modal" class="modal modal-front">
            <div class="modal-content">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Assign Ticket</h2>
                <label for="technician-name" class="block text-gray-700 font-medium text-sm">Technician Name:</label>
                <select id="technician-name" class="mt-1 p-2 w-full border rounded focus:outline-none focus:ring-2 focus:ring-blue-600 text-sm" required>
                    <option value="">Select Technician</option>
                    <option value="Luis Martinez">Luis Martinez</option>
                    <option value="Luis Almanza">Luis Almanza</option>
                    <option value="Jose Olivo">Jose Olivo</option>
                    <option value="Manuel Linares">Manuel Linares</option>
                    <option value="Jonathan Oropeza">Jonathan Oropeza</option>
                    <option value="Angel Velasquez">Angel Velasquez</option>
                    <option value="Adolfo Hernandez">Adolfo Hernandez</option>
                    <option value="Pedro Mejia">Pedro Mejia</option>
                    <option value="Gerardo Martinez">Gerardo Martinez</option>
                    <option value="Jesus Estrada">Jesus Estrada</option>
                    <option value="Ramiro Perez">Ramiro Perez</option>
                    <option value="Brandon Cerecero">Brandon Cerecero</option>
                    <option value="Jaekyoung Lim">Jaekyoung Lim</option>
                    <option value="Angel Dario">Angel Dario</option>
                    <option value="Angel Gustavo">Angel Gustavo</option>
                    <option value="Daniel Venegas">Daniel Venegas</option>
                    <option value="David Fernandez">David Fernandez</option>
                    <option value="Juan Carrillo">Juan Carrillo</option>
                    <option value="Julio Mojica">Julio Mojica</option>
                    <option value="Issac Balderas">Issac Balderas</option>
                </select>
                <div class="mt-4 flex space-x-2">
                    <button onclick="assignTicket()" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">Assign</button>
                    <button onclick="closeModal('assign-ticket-modal')" class="px-3 py-1 bg-gray-600 text-white rounded hover:bg-gray-700 text-sm">Cancel</button>
                </div>
            </div>
        </div>
        <div id="resolve-ticket-modal" class="modal modal-front">
            <div class="modal-content">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Resolve Ticket</h2>
                <label for="issue" class="block text-gray-700 font-medium text-sm">Issue:</label>
                <textarea id="issue" class="mt-1 p-2 w-full border rounded focus:outline-none focus:ring-2 focus:ring-blue-600 text-sm h-20" required></textarea>
                <label for="fix" class="block text-gray-700 font-medium text-sm mt-2">Fix:</label>
                <textarea id="fix" class="mt-1 p-2 w-full border rounded focus:outline-none focus:ring-2 focus:ring-blue-600 text-sm h-20" required></textarea>
                <div class="mt-4 flex space-x-2">
                    <button onclick="resolveTicket()" class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm">Resolve Ticket</button>
                    <button onclick="closeModal('resolve-ticket-modal')" class="px-3 py-1 bg-gray-600 text-white rounded hover:bg-gray-700 text-sm">Cancel</button>
                </div>
            </div>
        </div>
        <div id="line-tickets-modal" class="modal">
            <div class="modal-content">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Tickets for <span id="line-title"></span></h2>
                <div id="line-tickets-content" class="space-y-4 text-sm"></div>
                <button onclick="closeModal('line-tickets-modal')" class="mt-4 px-3 py-1 bg-gray-600 text-white rounded hover:bg-gray-700 text-sm">Close</button>
            </div>
        </div>
        <script>
            const operationsByLine = {
                MRR: [
                    'Magazine Loading', 'Flash Programming', 'PCB Separation', 'ICT',
                    'Housing Loader', 'Tim Dispensing', 'PCB Assembly', 'Cavity Plate Seating',
                    'Screwing', 'Sealant Application', 'Radome Assembly', 'Curing',
                    'Leak Test', 'Calibration Loader', 'EOL', 'Labelling', 'Bracket Assembly',
                    'General Conveyors'
                ],
                FCM: [
                    'Magazine Loading', 'Flash Programming', 'PCB Separation', 'ICT',
                    'Conformal Coating', 'Coating Inspection', 'Palletizer', 'Module-Flex PCB Connect',
                    'Imager Module Screwing', 'ECU-Flex PCB Conect', 'TIM Dispensing',
                    'Lower Housing Screwing', 'Calibration Loader', 'Aging 1', 'Aging2',
                    'EOL Test', 'Labeling', 'Coupler Assembly', 'General Conveyors'
                ],
                IDB: [
                    'Magazine Loading', 'Fuse Bending', 'Flash Programming', 'ICT',
                    'Conformal Coating', 'Coating Inspection', 'PCB Separation', 'Press Fit (Main)',
                    'TIM dispensing', 'FIPG Dispensing', 'Dispensing Inspection', 'Cover Assembly',
                    'CIPG Dispensing', 'CIPG Inspection', 'Input Robot', 'Hot chamber',
                    'Output Robot', 'Hot Function Test', 'Cooling', 'Leak Test',
                    'Coil height & CIPG', 'Label', 'General Conveyors'
                ],
                MGH: [
                    'Magazine Loading', 'Flash Programming', 'PCB Separation', 'Fuse Bending',
                    'ICT', 'Conformal Coating', 'Coating Inspection', 'Curing',
                    'Press Fit (Main)', 'Vibration Welding', 'Vacuum Cleaner', 'Leak Test',
                    'Hot chamber', 'Hot Function Test', 'Cooling', 'Coil Height',
                    'Pin Check', 'Laser Marking', 'Packing', 'General Conveyors'
                ],
                IAMM: [
                    'Magazine Loading', 'Flash Programming', 'ICT', 'PCB Separation',
                    'Press Fit (PCB)', 'Press Fit (Coil)', 'Vibration Welding', 'Leak Test',
                    'EOL', 'Pin Check', 'Label', 'Packing', 'General Conveyors'
                ],
                PPK: [
                    'Magazine Loading', 'ICT/Flash Programing', 'PCB Separation', 'PCB Loading',
                    'Conformal Coating', 'Curing', 'Coating Inspection', 'Manual Insertion Components',
                    'Selective Soldering', 'XRAY', 'AOI', 'ECU Function Test', 'Packing',
                    'General Conveyors'
                ]
            };

            let currentUser = null;
            let accessToken = localStorage.getItem('accessToken') || null;
            let alarmInterval = null;
            let chartInstance = null;
            let isTestAlarmPlaying = false;
            let hasUserInteracted = false;
            let cachedTickets = [];
            let cachedStats = { today: 0, week: 0 };
            let cachedDowntime = [];
            let lastFetchFailed = false;
            let lastResetDay = null;

            function getMexicoCityDate() {
                return new Date().toLocaleString('en-US', { timeZone: 'America/Mexico_City' });
            }

            function isNewDay() {
                const now = new Date(getMexicoCityDate());
                const hours = now.getHours();
                const currentDay = now.toLocaleDateString('en-US', { timeZone: 'America/Mexico_City' });
                // Reset at 8 AM Mexico City time. If current time is past 8 AM
                // and the last reset day is not today, it's a new "day" for stats.
                if (hours >= 8 && lastResetDay !== currentDay) {
                    lastResetDay = currentDay;
                    return true;
                }
                return false;
            }

            function showErrorNotification(message) {
                const notification = document.getElementById('error-notification');
                notification.textContent = message;
                notification.style.display = 'block';
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 5000);
            }

            window.addEventListener('load', () => {
                const overlay = document.createElement('div');
                overlay.style.position = 'fixed';
                overlay.style.top = '0';
                overlay.style.left = '0';
                overlay.style.width = '100%';
                overlay.style.height = '100%';
                overlay.style.background = 'rgba(0,0,0,0.5)';
                overlay.style.display = 'flex';
                overlay.style.alignItems = 'center';
                overlay.style.justifyContent = 'center';
                overlay.style.zIndex = '100';
                overlay.innerHTML = `
                    <div style="background: white; padding: 20px; border-radius: 8px; text-align: center;">
                        <p class="text-gray-800 mb-4">Click to enable audio alerts</p>
                        <button onclick="this.parentElement.parentElement.remove(); hasUserInteracted = true;" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Enable</button>
                    </div>
                `;
                document.body.appendChild(overlay);
            });

            function updateOperations() {
                const line = document.getElementById('line').value;
                const operationSelect = document.getElementById('operation');
                operationSelect.innerHTML = '<option value="">Select Operation</option>';
                if (line && operationsByLine[line]) {
                    operationsByLine[line].forEach(op => {
                        const option = document.createElement('option');
                        option.value = op;
                        option.textContent = op;
                        operationSelect.appendChild(option);
                    });
                }
            }

            function showScreen(screenId) {
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.add('hidden');
                });
                document.getElementById(screenId).classList.remove('hidden');
                console.log(`showScreen: Navigating to ${screenId}, timestamp: ${getMexicoCityDate()}`);
                if (screenId === 'dashboard') {
                    console.log('showScreen: Forcing immediate dashboard fetch and update');
                    fetchTicketData().then(success => {
                        if (success) loadDashboard();
                        else showErrorNotification('Failed to fetch dashboard data on navigation');
                    });
                }
                if (screenId === 'all-tickets') loadAllTickets();
                if (screenId === 'analytics') loadAnalytics();
            }

            function showModal(modalId, ticketId = null, line = null) {
                console.log('showModal called with:', { modalId, ticketId, line, timestamp: getMexicoCityDate() });
                currentTicketId = ticketId;
                currentLine = line;
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'block';
                    if (modalId === 'ticket-details-modal' && ticketId) {
                        loadTicketDetails(ticketId);
                    }
                } else {
                    console.error(`Modal with ID ${modalId} not found`);
                    showErrorNotification(`Modal ${modalId} not found`);
                }
            }

            function closeModal(modalId) {
                console.log('closeModal called with:', { modalId, timestamp: getMexicoCityDate() });
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'none';
                } else {
                    console.error(`Modal with ID ${modalId} not found`);
                }
                document.getElementById('technician-name').value = '';
                document.getElementById('issue').value = '';
                document.getElementById('fix').value = '';
                document.getElementById('login-email').value = '';
                document.getElementById('login-password').value = '';
            }

            function showLoginModal() {
                showModal('login-modal');
            }

            async function login() {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                if (!email || !password) {
                    showErrorNotification('Please enter email and password');
                    return;
                }
                try {
                    console.log('login: Attempting login for', email, 'timestamp:', getMexicoCityDate());
                    const response = await fetch('/api/login', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache',
                            'Expires': '0'
                        },
                        body: JSON.stringify({ email, password })
                    });
                    if (!response.ok) throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                    const { access_token, role } = await response.json();
                    accessToken = access_token;
                    localStorage.setItem('accessToken', accessToken);
                    currentUser = { role, email };
                    console.log('login: Success, role:', role);
                    updateUIForRole();
                    closeModal('login-modal');
                    showScreen('dashboard');
                } catch (error) {
                    console.error('login: Error', error);
                    showErrorNotification(`Failed to login: ${error.message}`);
                }
            }

            async function logout() {
                try {
                    console.log('logout: Attempting logout, timestamp:', getMexicoCityDate());
                    const response = await fetch('/api/logout', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache',
                            'Expires': '0'
                        }
                    });
                    if (!response.ok) throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                    accessToken = null;
                    localStorage.removeItem('accessToken');
                    currentUser = null;
                    console.log('logout: Success');
                    updateUIForRole();
                    stopAlarm();
                    showScreen('dashboard');
                } catch (error) {
                    console.error('logout: Error', error);
                    showErrorNotification(`Failed to logout: ${error.message}`);
                }
            }

            function updateUIForRole() {
                const loginBtn = document.getElementById('login-btn');
                const logoutBtn = document.getElementById('logout-btn');
                const submitTicketBtn = document.getElementById('submit-ticket-btn');
                const dashboardBtn = document.getElementById('dashboard-btn');
                const allTicketsBtn = document.getElementById('all-tickets-btn');
                const analyticsBtn = document.getElementById('analytics-btn');
                const testAlarmBtn = document.getElementById('test-alarm-btn');
                const userRole = document.getElementById('user-role');

                if (!currentUser) {
                    loginBtn.classList.remove('hidden');
                    logoutBtn.classList.add('hidden');
                    submitTicketBtn.classList.add('hidden');
                    dashboardBtn.classList.add('hidden');
                    allTicketsBtn.classList.add('hidden');
                    analyticsBtn.classList.add('hidden');
                    testAlarmBtn.classList.add('hidden');
                    userRole.textContent = 'Not logged in';
                    console.log('updateUIForRole: User not logged in, timestamp:', getMexicoCityDate());
                    return;
                }

                loginBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                userRole.textContent = `Role: ${currentUser.role}`;
                submitTicketBtn.classList.remove('hidden');
                dashboardBtn.classList.remove('hidden');
                allTicketsBtn.classList.remove('hidden');
                analyticsBtn.classList.remove('hidden');
                testAlarmBtn.classList.toggle('hidden', !['Manager', 'Maintenance Technician', 'Test Technician'].includes(currentUser.role));
                console.log('updateUIForRole: Updated for role', currentUser.role, 'timestamp:', getMexicoCityDate());
            }

            let currentTicketId = null;
            let currentLine = null;

            async function submitTicket() {
                const employeeId = document.getElementById('employee-id').value;
                const name = document.getElementById('name').value;
                const line = document.getElementById('line').value;
                const process = document.getElementById('operation').value;
                const description = document.getElementById('description').value;

                if (!employeeId || !name || !line || !process || !description) {
                    showErrorNotification('Please fill in all fields');
                    return;
                }

                try {
                    console.log('submitTicket: Submitting ticket', { employeeId, line, process }, 'timestamp:', getMexicoCityDate());
                    const response = await fetch('/api/tickets', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${accessToken}`,
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache',
                            'Expires': '0'
                        },
                        body: JSON.stringify({ employee_id: employeeId, name, line, process, description, status: 'Open', created_at: getMexicoCityDate() })
                    });
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }
                    const ticket = await response.json();
                    console.log('submitTicket: Success, ticket_id:', ticket.ticket_id);
                    document.getElementById('employee-id').value = '';
                    document.getElementById('name').value = '';
                    document.getElementById('line').value = '';
                    document.getElementById('operation').innerHTML = '<option value="">Select Operation</option>';
                    document.getElementById('description').value = '';
                    await fetchTicketData(); // Refetch data after submission
                    console.log('submitTicket: Forcing dashboard update');
                    loadDashboard(); // Update dashboard with new data
                    showScreen('dashboard'); // Navigate to dashboard
                    alert('Ticket submitted successfully');
                } catch (error) {
                    console.error('submitTicket: Error', error);
                    showErrorNotification(`Failed to submit ticket: ${error.message}`);
                }
            }

            function startAlarm() {
                if (!hasUserInteracted && !isTestAlarmPlaying) {
                    console.log('startAlarm: Blocked, no user interaction, timestamp:', getMexicoCityDate());
                    return;
                }
                const alarm = document.getElementById('alarm');
                alarm.play().catch(error => {
                    console.error('startAlarm: Error playing alarm', error);
                    showErrorNotification('Failed to play alarm. Ensure /beep-01a.mp3 is accessible.');
                });
            }

            function stopAlarm() {
                const alarm = document.getElementById('alarm');
                alarm.pause();
                alarm.currentTime = 0;
                isTestAlarmPlaying = false;
                console.log('stopAlarm: Alarm stopped, timestamp:', getMexicoCityDate());
                // Only restart the interval if it's currently null (meaning it was cleared)
                if (!alarmInterval) {
                    console.log('stopAlarm: Restarting polling interval (5s), timestamp:', getMexicoCityDate());
                    alarmInterval = setInterval(checkForAlarms, 5000);
                }
            }

            function testAlarm() {
                const alarm = document.getElementById('alarm');
                const testAlarmBtn = document.getElementById('test-alarm-btn');
                if (isTestAlarmPlaying) {
                    stopAlarm();
                    testAlarmBtn.textContent = 'Test Alarm';
                } else {
                    alarm.play().catch(error => {
                        console.error('testAlarm: Error playing alarm', error);
                        showErrorNotification('Failed to play alarm. Ensure /beep-01a.mp3 is accessible.');
                    });
                    isTestAlarmPlaying = true;
                    hasUserInteracted = true; // Assume user interaction if they click test alarm
                    testAlarmBtn.textContent = 'Stop Alarm';
                    console.log('testAlarm: Playing test alarm, timestamp:', getMexicoCityDate());
                }
            }

            async function fetchTicketData() {
                if (!accessToken) {
                    console.log('fetchTicketData: No access token, skipping, timestamp:', getMexicoCityDate());
                    lastFetchFailed = true;
                    return false;
                }
                // Check if it's a new "day" (after 8 AM local time) to reset daily stats
                if (isNewDay()) {
                    console.log('fetchTicketData: New day detected, resetting today stats and downtime, timestamp:', getMexicoCityDate());
                    cachedStats.today = 0; // Reset today's count
                    cachedDowntime = []; // Clear downtime data for the new day
                    lastResetDay = new Date(getMexicoCityDate()).toLocaleDateString('en-US', { timeZone: 'America/Mexico_City' });
                }
                const maxAttempts = 5;
                for (let attempt = 1; attempt <= maxAttempts; attempt++) {
                    try {
                        console.log(`fetchTicketData: Attempt ${attempt}/${maxAttempts}, timestamp: ${getMexicoCityDate()}`);
                        // Add cache-busting parameter to all requests
                        const cacheBuster = `cb=${Date.now()}-${Math.random().toString(36).substring(2)}`;
                        const ticketUrl = `/api/tickets?${cacheBuster}&timezone=America/Mexico_City`;
                        console.log('fetchTicketData: Fetching tickets', ticketUrl);
                        const ticketResponse = await fetch(ticketUrl, {
                            headers: { 
                                'Authorization': `Bearer ${accessToken}`,
                                'Cache-Control': 'no-cache, no-store, must-revalidate',
                                'Pragma': 'no-cache',
                                'Expires': '0'
                            }
                        });
                        if (!ticketResponse.ok) {
                            const errorText = await ticketResponse.text();
                            throw new Error(`Tickets HTTP ${ticketResponse.status}: ${errorText}`);
                        }
                        const tickets = await ticketResponse.json();
                        console.log('fetchTicketData: Tickets received', tickets.length, 'tickets', JSON.stringify(tickets.slice(0, 2)));

                        const statsUrl = `/api/ticket-stats?${cacheBuster}&timezone=America/Mexico_City`;
                        console.log('fetchTicketData: Fetching stats', statsUrl);
                        const statsResponse = await fetch(statsUrl, {
                            headers: { 
                                'Authorization': `Bearer ${accessToken}`,
                                'Cache-Control': 'no-cache, no-store, must-revalidate',
                                'Pragma': 'no-cache',
                                'Expires': '0'
                            }
                        });
                        if (!statsResponse.ok) {
                            const errorText = await statsResponse.text();
                            throw new Error(`Stats HTTP ${statsResponse.status}: ${errorText}`);
                        }
                        cachedStats = await statsResponse.json();
                        console.log('fetchTicketData: Stats received', JSON.stringify(cachedStats));
                        // Ensure 'today' is a valid number, default to 0 if not
                        if (typeof cachedStats.today === 'undefined' || cachedStats.today === null || cachedStats.today < 0) {
                            console.warn('fetchTicketData: stats.today is invalid, defaulting to 0', cachedStats.today);
                            cachedStats.today = 0;
                        }

                        const downtimeUrl = `/api/downtime?${cacheBuster}&timezone=America/Mexico_City`;
                        console.log('fetchTicketData: Fetching downtime', downtimeUrl);
                        const downtimeResponse = await fetch(downtimeUrl, {
                            headers: { 
                                'Authorization': `Bearer ${accessToken}`,
                                'Cache-Control': 'no-cache, no-store, must-revalidate',
                                'Pragma': 'no-cache',
                                'Expires': '0'
                            }
                        });
                        if (!downtimeResponse.ok) {
                            const errorText = await downtimeResponse.text();
                            throw new Error(`Downtime HTTP ${downtimeResponse.status}: ${errorText}`);
                        }
                        cachedDowntime = await downtimeResponse.json();
                        console.log('fetchTicketData: Downtime received', JSON.stringify(cachedDowntime));

                        cachedTickets = tickets; // Update cached tickets from the /api/tickets endpoint
                        lastFetchFailed = false; // Reset flag on success
                        console.log('fetchTicketData: Success, ticket count:', tickets.length);
                        return true; // Indicate success
                    } catch (error) {
                        console.error(`fetchTicketData: Attempt ${attempt}/${maxAttempts} failed`, error);
                        if (attempt === maxAttempts) {
                            lastFetchFailed = true; // Set flag if all attempts fail
                            console.error('fetchTicketData: All attempts failed', error);
                            showErrorNotification(`Failed to fetch data after ${maxAttempts} attempts: ${error.message}`);
                            return false; // Indicate failure
                        }
                        const backoff = Math.pow(2, attempt) * 1000; // Exponential backoff: 1s, 2s, 4s, 8s, 16s
                        console.log(`fetchTicketData: Waiting ${backoff}ms before retry`);
                        await new Promise(resolve => setTimeout(resolve, backoff));
                    }
                }
            }

            async function checkForAlarms() {
                if (!accessToken) {
                    console.log('checkForAlarms: No access token, skipping, timestamp:', getMexicoCityDate());
                    lastFetchFailed = true; // Consider no token as a "failed" state for continuous operation
                    return;
                }
                try {
                    // Only force a refetch if the last one failed, otherwise use cached data for polling
                    if (lastFetchFailed) {
                        console.warn('checkForAlarms: Previous fetch failed, forcing refresh, timestamp:', getMexicoCityDate());
                    }
                    const success = await fetchTicketData();
                    if (!success) {
                        console.error('checkForAlarms: Fetch failed, timestamp:', getMexicoCityDate());
                        lastFetchFailed = true; // Ensure flag is set if fetchTicketData reports failure
                        return;
                    }

                    const openTickets = cachedTickets.filter(t => t.status === 'Open');
                    console.log('checkForAlarms: Open tickets', openTickets.length, 'timestamp:', getMexicoCityDate());

                    const now = new Date(getMexicoCityDate());
                    const threeMinutesAgo = new Date(now.getTime() - 3 * 60 * 1000); // 3 minutes for alert
                    const overdueTickets = openTickets.filter(ticket => new Date(ticket.created_at).getTime() < threeMinutesAgo.getTime());
                    console.log('checkForAlarms: Overdue tickets', overdueTickets.length, 'timestamp:', getMexicoCityDate());

                    if (overdueTickets.length > 0 && !isTestAlarmPlaying) {
                        console.log('checkForAlarms: Starting alarm for overdue tickets, timestamp:', getMexicoCityDate());
                        startAlarm();
                    } else if (!isTestAlarmPlaying) { // Stop alarm only if no overdue tickets AND not in test mode
                        console.log('checkForAlarms: Stopping alarm, timestamp:', getMexicoCityDate());
                        stopAlarm();
                    }

                    console.log('checkForAlarms: Updating dashboard, timestamp:', getMexicoCityDate());
                    loadDashboard(); // Always update dashboard with the latest cached data
                } catch (error) {
                    console.error('checkForAlarms: Error', error, 'timestamp:', getMexicoCityDate());
                    lastFetchFailed = true; // Set flag if an error occurs during checking
                    showErrorNotification(`Error in checkForAlarms: ${error.message}`);
                }
            }

            async function loadDashboard() {
                if (!accessToken) {
                    console.log('loadDashboard: No access token, skipping, timestamp:', getMexicoCityDate());
                    return;
                }
                try {
                    console.log('loadDashboard: Updating UI with cached data', {
                        ticketCount: cachedTickets.length,
                        stats: cachedStats,
                        downtimeLines: cachedDowntime.length,
                        timestamp: getMexicoCityDate()
                    });
                    const tickets = cachedTickets;
                    const stats = cachedStats;
                    const downtimeData = cachedDowntime;

                    const lines = ['MRR', 'FCM', 'IDB', 'MGH', 'PPK', 'IAMM'];
                    lines.forEach(line => {
                        const openTickets = tickets.filter(t => t.line === line && t.status === 'Open').length;
                        const ongoingTickets = tickets.filter(t => t.line === line && t.status === 'Ongoing').length;
                        const box = document.getElementById(`${line.toLowerCase()}-box`);
                        // Reset classes before adding new ones
                        box.classList.remove('flash-red', 'flash-yellow', 'bg-green-200');
                        if (openTickets > 0) {
                            box.classList.add('flash-red');
                        } else if (ongoingTickets > 0) {
                            box.classList.add('flash-yellow');
                        } else {
                            box.classList.add('bg-green-200');
                        }
                        document.getElementById(`${line.toLowerCase()}-open`).textContent = openTickets;
                        document.getElementById(`${line.toLowerCase()}-ongoing`).textContent = ongoingTickets;
                        console.log(`loadDashboard: Updated ${line} - Open: ${openTickets}, Ongoing: ${ongoingTickets}`);
                    });

                    // Safely get today's ticket count
                    const safeTicketsToday = typeof stats.today === 'undefined' || stats.today === null || stats.today < 0 ? 0 : stats.today;
                    if (typeof stats.today === 'undefined' || stats.today === null || stats.today < 0) {
                        console.warn('loadDashboard: stats.today is invalid, defaulting to 0', stats.today);
                    }
                    document.getElementById('tickets-today').textContent = safeTicketsToday;
                    document.getElementById('tickets-week').textContent = stats.week || 0; // Display 0 if stats.week is undefined/null

                    const downtimeTable = document.getElementById('downtime-table');
                    downtimeTable.innerHTML = ''; // Clear existing rows
                    downtimeData.forEach(({ line, tickets_generated, downtime }) => {
                        // Ensure tickets_generated and downtime are valid numbers
                        const safeTicketsGenerated = typeof tickets_generated === 'undefined' || tickets_generated === null || tickets_generated < 0 ? 0 : tickets_generated;
                        const safeDowntime = typeof downtime === 'number' && downtime >= 0 ? downtime : 0; // Ensure downtime is non-negative
                        
                        if (typeof tickets_generated === 'undefined' || tickets_generated === null || tickets_generated < 0) {
                            console.warn(`loadDashboard: tickets_generated is invalid for line ${line}, defaulting to 0`, tickets_generated);
                        }
                        if (typeof downtime === 'number' && downtime < 0) {
                            console.warn(`loadDashboard: Negative downtime (${downtime}) detected for line ${line}, defaulting to 0`);
                        }
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-gray-50';
                        row.innerHTML = `
                            <td class="p-2">${line}</td>
                            <td class="p-2">${safeTicketsGenerated}</td>
                            <td class="p-2">${safeDowntime}</td>
                        `;
                        downtimeTable.appendChild(row);
                    });
                    console.log('loadDashboard: UI update complete, timestamp:', getMexicoCityDate());
                } catch (error) {
                    console.error('loadDashboard: Error', error, 'timestamp:', getMexicoCityDate());
                    showErrorNotification(`Failed to load dashboard: ${error.message}`);
                }
            }

            async function loadAllTickets() {
                const ticketList = document.getElementById('ticket-list');
                ticketList.innerHTML = ''; // Clear existing list
                try {
                    const ticketIdFilter = document.getElementById('filter-ticket-id').value;
                    const employeeIdFilter = document.getElementById('filter-employee-id').value;
                    const lineFilter = document.getElementById('filter-line').value;
                    const processFilter = document.getElementById('filter-process').value;
                    const descriptionFilter = document.getElementById('filter-description').value;
                    const statusFilter = document.getElementById('filter-status').value;
                    const fromDate = document.getElementById('filter-from-date').value;
                    const toDate = document.getElementById('filter-to-date').value;

                    const queryParams = [`sort=created_at_desc`, `timezone=America/Mexico_City`];
                    if (ticketIdFilter) queryParams.push(`ticket_id=${encodeURIComponent(ticketIdFilter)}`);
                    if (employeeIdFilter) queryParams.push(`employee_id=${encodeURIComponent(employeeIdFilter)}`);
                    if (lineFilter) queryParams.push(`line=${encodeURIComponent(lineFilter)}`);
                    if (processFilter) queryParams.push(`process=${encodeURIComponent(processFilter)}`);
                    if (descriptionFilter) queryParams.push(`description=${encodeURIComponent(descriptionFilter)}`);
                    if (statusFilter) queryParams.push(`status=${encodeURIComponent(statusFilter)}`);
                    if (fromDate) queryParams.push(`from=${encodeURIComponent(fromDate)}`);
                    if (toDate) queryParams.push(`to=${encodeURIComponent(toDate)}`);
                    // Add cache-busting for filter changes to ensure fresh data
                    queryParams.push(`cb=${Date.now()}-${Math.random().toString(36).substring(2)}`);

                    const url = `/api/tickets?${queryParams.join('&')}`;
                    console.log('loadAllTickets: Fetching tickets from', url, 'timestamp:', getMexicoCityDate());
                    const response = await fetch(url, {
                        headers: { 
                            'Authorization': `Bearer ${accessToken}`,
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache',
                            'Expires': '0'
                        }
                    });
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP ${response.status}: ${errorText || 'Not Found'}`);
                    }
                    const tickets = await response.json();
                    console.log('loadAllTickets: Tickets received', tickets.length, 'timestamp:', getMexicoCityDate());
                    if (tickets.length === 0) {
                        ticketList.innerHTML = '<tr><td colspan="7" class="p-2 text-gray-600 text-center">No tickets found</td></tr>';
                        return;
                    }
                    tickets.forEach(ticket => {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-gray-50';
                        row.innerHTML = `
                            <td class="p-2"><a href="#" onclick="showModal('ticket-details-modal', '${ticket.ticket_id}')" class="text-blue-600 hover:underline">${ticket.ticket_id}</a></td>
                            <td class="p-2">${ticket.employee_id}</td>
                            <td class="p-2">${ticket.line}</td>
                            <td class="p-2">${ticket.process}</td>
                            <td class="p-2">${new Date(ticket.created_at).toLocaleString('en-US', { timeZone: 'America/Mexico_City' })}</td>
                            <td class="p-2">${ticket.description}</td>
                            <td class="p-2"><a href="#" onclick="handleStatusClick('${ticket.ticket_id}', '${ticket.status}')" class="text-blue-600 hover:underline">${ticket.status}</a></td>
                        `;
                        ticketList.appendChild(row);
                    });
                } catch (error) {
                    console.error('loadAllTickets: Error', error, 'timestamp:', getMexicoCityDate());
                    ticketList.innerHTML = '<tr><td colspan="7" class="p-2 text-red-600 text-center">Failed to load tickets: ' + error.message + '</td></tr>';
                    showErrorNotification(`Failed to load tickets: ${error.message}`);
                }
            }

            async function loadTicketDetails(ticketId) {
                try {
                    const url = `/api/tickets/${ticketId}?cb=${Date.now()}-${Math.random().toString(36).substring(2)}&timezone=America/Mexico_City`;
                    console.log('loadTicketDetails: Fetching', url, 'timestamp:', getMexicoCityDate());
                    const response = await fetch(url, {
                        headers: { 
                            'Authorization': `Bearer ${accessToken}`,
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache',
                            'Expires': '0'
                        }
                    });
                    if (!response.ok) throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                    const ticket = await response.json();
                    console.log('loadTicketDetails: Ticket received', ticket.ticket_id, 'timestamp:', getMexicoCityDate());
                    document.getElementById('ticket-details-content').innerHTML = `
                        <p class="mb-2"><strong>Ticket ID:</strong> ${ticket.ticket_id}</p>
                        <p class="mb-2"><strong>Employee ID:</strong> ${ticket.employee_id}</p>
                        <p class="mb-2"><strong>Name:</strong> ${ticket.name}</p>
                        <p class="mb-2"><strong>Line:</strong> ${ticket.line}</p>
                        <p class="mb-2"><strong>Process:</strong> ${ticket.process}</p>
                        <p class="mb-2"><strong>Created At:</strong> ${new Date(ticket.created_at).toLocaleString('en-US', { timeZone: 'America/Mexico_City' })}</p>
                        <p class="mb-2"><strong>Description:</strong> ${ticket.description}</p>
                        <p class="mb-2"><strong>Status:</strong> ${ticket.status}</p>
                        <p class="mb-2"><strong>Assigned To:</strong> ${ticket.assigned_to || 'Not assigned'}</p>
                        <p class="mb-2"><strong>Assigned At:</strong> ${ticket.assigned_at ? new Date(ticket.assigned_at).toLocaleString('en-US', { timeZone: 'America/Mexico_City' }) : 'N/A'}</p>
                        <p class="mb-2"><strong>Resolved At:</strong> ${ticket.resolved_at ? new Date(ticket.resolved_at).toLocaleString('en-US', { timeZone: 'America/Mexico_City' }) : 'N/A'}</p>
                        <p class="mb-2"><strong>Resolved By:</strong> ${ticket.resolved_by || 'N/A'}</p>
                        <p class="mb-2"><strong>Issue:</strong> ${ticket.issue || 'N/A'}</p>
                        <p class="mb-2"><strong>Fix:</strong> ${ticket.fix || 'N/A'}</p>
                    `;
                } catch (error) {
                    console.error('loadTicketDetails: Error', error, 'timestamp:', getMexicoCityDate());
                    showErrorNotification(`Failed to load ticket details: ${error.message}`);
                }
            }

            async function loadLineTickets(line) {
                console.log('loadLineTickets called with:', { line, timestamp: getMexicoCityDate() });
                try {
                    // Fetch all open and ongoing tickets, then filter by line on the frontend
                    const url = `/api/tickets?status=Open,Ongoing&cb=${Date.now()}-${Math.random().toString(36).substring(2)}&timezone=America/Mexico_City`;
                    console.log('loadLineTickets: Fetching', url, 'timestamp:', getMexicoCityDate());
                    const response = await fetch(url, {
                        headers: { 
                            'Authorization': `Bearer ${accessToken}`,
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache',
                            'Expires': '0'
                        }
                    });
                    if (!response.ok) throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                    const tickets = await response.json();
                    const lineTickets = tickets.filter(t => t.line === line && ['Open', 'Ongoing'].includes(t.status));
                    console.log('loadLineTickets: Received', lineTickets.length, 'tickets for', line, 'timestamp:', getMexicoCityDate());
                    document.getElementById('line-title').textContent = line;
                    const content = document.getElementById('line-tickets-content');
                    content.innerHTML = ''; // Clear previous content
                    if (lineTickets.length === 0) {
                        content.innerHTML = '<p class="text-gray-600">No Open or Ongoing tickets for this line.</p>';
                    } else {
                        lineTickets.forEach(ticket => {
                            const ticketDiv = document.createElement('div');
                            ticketDiv.className = 'bg-white p-4 rounded-lg shadow-md mb-4';
                            let buttons = `
                                <button class="details-btn px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm" data-ticket-id="${ticket.ticket_id}">Details</button>
                            `;
                            // Only show assign/resolve buttons if user has appropriate role
                            if (['Manager', 'Maintenance Technician', 'Test Technician'].includes(currentUser?.role)) {
                                if (ticket.status === 'Open') {
                                    buttons += `<button class="assign-btn px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm" data-ticket-id="${ticket.ticket_id}" data-status="Open">Assign</button>`;
                                } else if (ticket.status === 'Ongoing') {
                                    buttons += `<button class="resolve-btn px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm" data-ticket-id="${ticket.ticket_id}" data-status="Ongoing">Resolve</button>`;
                                }
                            }
                            ticketDiv.innerHTML = `
                                <p class="font-semibold text-gray-800">${ticket.ticket_id} (Status: ${ticket.status})</p>
                                <p class="text-gray-600">Process: ${ticket.process}</p>
                                <p class="text-gray-600">Description: ${ticket.description}</p>
                                <p class="text-gray-600">Created: ${new Date(ticket.created_at).toLocaleString('en-US', { timeZone: 'America/Mexico_City' })}</p>
                                <div class="mt-2 flex space-x-2">${buttons}</div>
                            `;
                            content.appendChild(ticketDiv);
                        });
                    }
                    showModal('line-tickets-modal', null, line); // Open the modal
                    // Add event listener to the content for delegated clicks
                    content.addEventListener('click', (event) => {
                        const target = event.target;
                        if (target.classList.contains('details-btn')) {
                            const ticketId = target.getAttribute('data-ticket-id');
                            console.log('Details button clicked:', { ticketId, timestamp: getMexicoCityDate() });
                            showModal('ticket-details-modal', ticketId);
                        } else if (target.classList.contains('assign-btn') && ['Manager', 'Maintenance Technician', 'Test Technician'].includes(currentUser?.role)) {
                            const ticketId = target.getAttribute('data-ticket-id');
                            const status = target.getAttribute('data-status');
                            console.log('Assign button clicked:', { ticketId, status, timestamp: getMexicoCityDate() });
                            handleStatusClick(ticketId, status);
                        } else if (target.classList.contains('resolve-btn') && ['Manager', 'Maintenance Technician', 'Test Technician'].includes(currentUser?.role)) {
                            const ticketId = target.getAttribute('data-ticket-id');
                            const status = target.getAttribute('data-status');
                            console.log('Resolve button clicked:', { ticketId, status, timestamp: getMexicoCityDate() });
                            handleStatusClick(ticketId, status);
                        }
                    });
                } catch (error) {
                    console.error('loadLineTickets: Error', error, 'timestamp:', getMexicoCityDate());
                    showErrorNotification(`Failed to load line tickets: ${error.message}`);
                }
            }

            function handleStatusClick(ticketId, status) {
                console.log('handleStatusClick called with:', { ticketId, status, timestamp: getMexicoCityDate() });
                if (!ticketId) {
                    console.error('handleStatusClick: No ticketId provided', 'timestamp:', getMexicoCityDate());
                    showErrorNotification('Error: No ticket selected');
                    return;
                }
                currentTicketId = ticketId; // Set the global currentTicketId for modal actions
                console.log('handleStatusClick: Set currentTicketId:', currentTicketId, 'timestamp:', getMexicoCityDate());
                if (status === 'Open' && ['Manager', 'Maintenance Technician', 'Test Technician'].includes(currentUser?.role)) {
                    showModal('assign-ticket-modal', ticketId);
                } else if (status === 'Ongoing' && ['Manager', 'Maintenance Technician', 'Test Technician'].includes(currentUser?.role)) {
                    showModal('resolve-ticket-modal', ticketId);
                }
            }

            async function assignTicket() {
                const technicianName = document.getElementById('technician-name').value;
                if (!technicianName) {
                    showErrorNotification('Please select a technician');
                    return;
                }
                if (!currentTicketId) {
                    console.error('assignTicket: No currentTicketId', 'timestamp:', getMexicoCityDate());
                    showErrorNotification('Error: No ticket selected');
                    return;
                }
                console.log('assignTicket: Assigning ticket', { ticketId: currentTicketId, technicianName, timestamp: getMexicoCityDate() });
                try {
                    const response = await fetch(`/api/tickets/${currentTicketId}/assign`, {
                        method: 'PUT',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${accessToken}`,
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache',
                            'Expires': '0'
                        },
                        body: JSON.stringify({ assigned_to: technicianName, status: 'Ongoing', assigned_at: getMexicoCityDate() })
                    });
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }
                    console.log('assignTicket: Success, timestamp:', getMexicoCityDate());
                    closeModal('assign-ticket-modal');
                    if (currentLine) loadLineTickets(currentLine); // Reload line-specific tickets if applicable
                    loadAllTickets(); // Reload all tickets to reflect status change
                    await fetchTicketData(); // Refetch global data
                    console.log('assignTicket: Forcing dashboard update, timestamp:', getMexicoCityDate());
                    loadDashboard(); // Update dashboard
                    alert('Ticket assigned successfully');
                } catch (error) {
                    console.error('assignTicket: Error', error, 'timestamp:', getMexicoCityDate());
                    showErrorNotification(`Failed to assign ticket: ${error.message}`);
                }
            }

            async function resolveTicket() {
                const issue = document.getElementById('issue').value;
                const fix = document.getElementById('fix').value;
                if (!issue || !fix) {
                    showErrorNotification('Please fill in issue and fix');
                    return;
                }
                if (!currentTicketId) {
                    console.error('resolveTicket: No currentTicketId', 'timestamp:', getMexicoCityDate());
                    showErrorNotification('Error: No ticket selected');
                    return;
                }
                try {
                    // Fetch the ticket first to get the assigned_to name for resolved_by
                    const ticketUrl = `/api/tickets/${currentTicketId}?cb=${Date.now()}-${Math.random().toString(36).substring(2)}&timezone=America/Mexico_City`;
                    console.log('resolveTicket: Fetching ticket', ticketUrl, 'timestamp:', getMexicoCityDate());
                    const ticketResponse = await fetch(ticketUrl, {
                        headers: { 
                            'Authorization': `Bearer ${accessToken}`,
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache',
                            'Expires': '0'
                        }
                    });
                    if (!ticketResponse.ok) throw new Error(`HTTP ${ticketResponse.status}: ${await ticketResponse.text()}`);
                    const ticket = await ticketResponse.json();
                    const resolvedBy = ticket.assigned_to || 'Unknown'; // Use assigned_to as resolved_by

                    console.log('resolveTicket: Resolving ticket', { ticketId: currentTicketId, issue, fix, resolvedBy }, 'timestamp:', getMexicoCityDate());
                    const response = await fetch(`/api/tickets/${currentTicketId}/resolve`, {
                        method: 'PUT',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${accessToken}`,
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache',
                            'Expires': '0'
                        },
                        body: JSON.stringify({ issue, fix, status: 'Closed', resolved_by: resolvedBy, resolved_at: getMexicoCityDate() })
                    });
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }
                    console.log('resolveTicket: Success, timestamp:', getMexicoCityDate());
                    closeModal('resolve-ticket-modal');
                    if (currentLine) loadLineTickets(currentLine); // Reload line-specific tickets if applicable
                    loadAllTickets(); // Reload all tickets to reflect status change
                    await fetchTicketData(); // Refetch global data
                    console.log('resolveTicket: Forcing dashboard update, timestamp:', getMexicoCityDate());
                    loadDashboard(); // Update dashboard
                    alert('Ticket resolved successfully');
                } catch (error) {
                    console.error('resolveTicket: Error', error, 'timestamp:', getMexicoCityDate());
                    showErrorNotification(`Failed to resolve ticket: ${error.message}`);
                }
            }

            async function loadAnalytics() {
                try {
                    const line = document.getElementById('analytics-line').value;
                    const type = document.getElementById('analytics-type').value;
                    const fromDate = document.getElementById('from-date').value;
                    const toDate = document.getElementById('to-date').value;
                    if (!line || !type) return; // Don't proceed without selected line and type

                    const baseUrl = `/api/${type === 'downtime' ? 'downtime-by-process' : 'tickets-by-process'}`;
                    const queryParams = [`line=${encodeURIComponent(line)}`, `cb=${Date.now()}-${Math.random().toString(36).substring(2)}`, `timezone=America/Mexico_City`];
                    if (fromDate) queryParams.push(`from=${encodeURIComponent(fromDate)}`);
                    if (toDate) queryParams.push(`to=${encodeURIComponent(toDate)}`);
                    const url = `${baseUrl}?${queryParams.join('&')}`;
                    console.log('loadAnalytics: Fetching', url, 'timestamp:', getMexicoCityDate());
                    const response = await fetch(url, {
                        headers: { 
                            'Authorization': `Bearer ${accessToken}`,
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache',
                            'Expires': '0'
                        }
                    });
                    if (!response.ok) throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                    let data = await response.json();
                    console.log('loadAnalytics: Data received', data.length, 'items', 'timestamp:', getMexicoCityDate());
                    // Filter out items with zero value and sort
                    data = data.filter(item => (type === 'downtime' ? item.downtime : item.count) > 0)
                        .sort((a, b) => {
                            const valueA = type === 'downtime' ? a.downtime : a.count;
                            const valueB = type === 'downtime' ? b.downtime : b.count;
                            return valueB - valueA || a.process.localeCompare(b.process); // Sort by value desc, then by process name asc
                        });

                    const labels = data.map(item => item.process);
                    const values = data.map(item => type === 'downtime' ? item.downtime : item.count);

                    if (chartInstance) chartInstance.destroy(); // Destroy previous chart instance
                    const ctx = document.getElementById('analytics-chart').getContext('2d');
                    chartInstance = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels,
                            datasets: [{
                                label: type === 'downtime' ? 'Downtime (Minutes)' : 'Tickets Created',
                                data: values,
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: type === 'downtime' ? 'Downtime (Minutes)' : 'Number of Tickets'
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Process'
                                    }
                                }
                            },
                            plugins: {
                                legend: { display: true },
                                title: {
                                    display: true,
                                    text: type === 'downtime' ? `Downtime per Process for ${line}` : `Tickets per Process for ${line}`
                                }
                            }
                        }
                    });

                    //updateTechnicianTable(); // Update technician performance table as well
                } catch (error) {
                    console.error('loadAnalytics: Error', error, 'timestamp:', getMexicoCityDate());
                    showErrorNotification(`Failed to load analytics: ${error.message}`);
                }
            }

            async function updateTechnicianTable() {
                try {
                    const line = document.getElementById('analytics-line').value;
                    const fromDate = document.getElementById('from-date').value;
                    const toDate = document.getElementById('to-date').value;
                    const baseUrl = '/api/technician-stats';
                    const queryParams = [`cb=${Date.now()}-${Math.random().toString(36).substring(2)}`, `timezone=America/Mexico_City`];
                    if (line) queryParams.push(`line=${encodeURIComponent(line)}`);
                    if (fromDate) queryParams.push(`from=${encodeURIComponent(fromDate)}`);
                    if (toDate) queryParams.push(`to=${encodeURIComponent(toDate)}`);
                    const url = `${baseUrl}?${queryParams.join('&')}`;
                    console.log('updateTechnicianTable: Fetching', url, 'timestamp:', getMexicoCityDate());
                    const response = await fetch(url, {
                        headers: { 
                            'Authorization': `Bearer ${accessToken}`,
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache',
                            'Expires': '0'
                        }
                    });
                    if (!response.ok) throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                    const data = await response.json();
                    console.log('updateTechnicianTable: Data received', data.length, 'items', 'timestamp:', getMexicoCityDate());
                    const tbody = document.getElementById('technician-table');
                    tbody.innerHTML = ''; // Clear existing rows
                    data.forEach(item => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td class="p-2">${item.technician || 'Unassigned'}</td>
                            <td class="p-2">${item.tickets_resolved}</td>
                            <td class="p-2">${Math.round(item.total_resolve_time)}</td>
                            <td class="p-2">${Math.round(item.total_downtime)}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                    if (!data.length) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td class="p-2" colspan="4">No technician data available</td>`;
                        tbody.appendChild(tr);
                    }
                } catch (error) {
                    console.error('updateTechnicianTable: Error', error, 'timestamp:', getMexicoCityDate());
                    showErrorNotification(`Failed to load technician data: ${error.message}`);
                }
            }

            async function init() {
                try {
                    if (accessToken) {
                        const url = `/api/user?cb=${Date.now()}-${Math.random().toString(36).substring(2)}&timezone=America/Mexico_City`;
                        console.log('init: Validating token', url, 'timestamp:', getMexicoCityDate());
                        const response = await fetch(url, {
                            headers: { 
                                'Authorization': `Bearer ${accessToken}`,
                                'Cache-Control': 'no-cache, no-store, must-revalidate',
                                'Pragma': 'no-cache',
                                'Expires': '0'
                            }
                        });
                        if (response.ok) {
                            const { role, email } = await response.json();
                            currentUser = { role, email };
                            console.log('init: Token valid, user:', email, 'role:', role, 'timestamp:', getMexicoCityDate());
                            await fetchTicketData(); // Fetch initial data immediately after successful login
                        } else {
                            console.warn('init: Invalid access token, clearing, timestamp:', getMexicoCityDate());
                            localStorage.removeItem('accessToken');
                            accessToken = null;
                        }
                    }
                    updateUIForRole();
                    showScreen('dashboard'); // Always show dashboard on init
                    // Start the alarm polling only once
                    if (!alarmInterval) {
                        console.log('init: Starting polling interval (5s), timestamp:', getMexicoCityDate());
                        alarmInterval = setInterval(checkForAlarms, 5000); // Poll every 5 seconds
                    }
                } catch (error) {
                    console.error('init: Error', error, 'timestamp:', getMexicoCityDate());
                    updateUIForRole(); // Still try to update UI even if init fetch fails
                    showScreen('dashboard'); // Still show dashboard
                    showErrorNotification(`Initialization failed: ${error.message}`);
                }
            }

            init(); // Call init when the script loads
        </script>
    </body>
</html>