<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maintenance Ticketing App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <style>
        @keyframes flash-red {
            0%, 100% { background-color: #ef4444; }
            50% { background-color: #dc2626; }
        }
        @keyframes flash-yellow {
            0%, 100% { background-color: #facc15; }
            50% { background-color: #eab308; }
        }
        .flash-red { animation: flash-red 1s infinite; }
        .flash-yellow { animation: flash-yellow 1s infinite; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 50; }
        .modal-content { background: white; margin: 10% auto; padding: 20px; width: 90%; max-width: 500px; border-radius: 0.5rem; max-height: 80vh; overflow-y: auto; }
        .modal-front { z-index: 60; }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <audio id="alarm" loop>
        <source src="/beep-01a.mp3" type="audio/mpeg">
        <source src="https://www.soundjay.com/buttons/beep-01a.mp3" type="audio/mpeg">
    </audio>
    <div class="container mx-auto p-4 max-w-3xl">
        <div id="auth-section" class="mb-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">Maintenance Ticketing App</h1>
            <div>
                <span id="user-role" class="text-gray-700 mr-4 text-sm"></span>
                <button id="login-btn" onclick="showLoginModal()" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">Login</button>
                <button id="logout-btn" onclick="logout()" class="hidden px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm">Logout</button>
            </div>
        </div>
        <div id="nav-buttons" class="flex flex-wrap gap-2 mb-4">
            <button id="submit-ticket-btn" onclick="showScreen('submit-ticket')" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm hidden">Submit Ticket</button>
            <button id="dashboard-btn" onclick="showScreen('dashboard')" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm hidden">Dashboard</button>
            <button id="all-tickets-btn" onclick="showScreen('all-tickets')" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm hidden">All Tickets</button>
            <button id="analytics-btn" onclick="showScreen('analytics')" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm hidden">Analytics</button>
            <button id="test-alarm-btn" onclick="testAlarm()" class="hidden px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm">Test Alarm</button>
            <button id="refresh-btn" onclick="refreshDashboard()" class="px-3 py-1 bg-gray-600 text-white rounded hover:bg-gray-700 text-sm hidden">Refresh Dashboard</button>
        </div>
        <div id="submit-ticket" class="screen hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Submit a New Ticket</h2>
            <form onsubmit="event.preventDefault(); submitTicket();" class="bg-white p-4 rounded-lg shadow-md">
                <div class="mb-2">
                    <label for="employee-id" class="block text-gray-700 font-medium text-sm">ID de Empleado:</label>
                    <input type="text" id="employee-id" class="mt-1 p-2 w-full border rounded focus:outline-none focus:ring-2 focus:ring-blue-600 text-sm" required>
                </div>
                <div class="mb-2">
                    <label for="name" class="block text-gray-700 font-medium text-sm">Nombre:</label>
                    <input type="text" id="name" class="mt-1 p-2 w-full border rounded focus:outline-none focus:ring-2 focus:ring-blue-600 text-sm" required>
                </div>
                <div class="mb-2">
                    <label for="line" class="block text-gray-700 font-medium text-sm">Línea:</label>
                    <select id="line" onchange="updateOperations()" class="mt-1 p-2 w-full border rounded focus:outline-none focus:ring-2 focus:ring-blue-600 text-sm" required>
                        <option value="">Select Line</option>
                        <option value="MRR">MRR</option>
                        <option value="FCM">FCM</option>
                        <option value="IDB">IDB</option>
                        <option value="MGH">MGH</option>
                        <option value="PPK">PPK</option>
                        <option value="IAMM">IAMM</option>
                    </select>
                </div>
                <div class="mb-2">
                    <label for="operation" class="block text-gray-700 font-medium text-sm">Operación:</label>
                    <select id="operation" class="mt-1 p-2 w-full border rounded focus:outline-none focus:ring-2 focus:ring-blue-600 text-sm" required>
                        <option value="">Select Operation</option>
                    </select>
                </div>
                <div class="mb-2">
                    <label for="description" class="block text-gray-700 font-medium text-sm">Descripción del Problema:</label>
                    <textarea id="description" class="mt-1 p-2 w-full border rounded focus:outline-none focus:ring-2 focus:ring-blue-600 text-sm h-20" required></textarea>
                </div>
                <button type="submit" class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm w-full">Submit Ticket</button>
            </form>
        </div>
        <div id="dashboard" class="screen hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Dashboard</h2>
            <div class="grid grid-cols-3 gap-2 mb-4">
                <div id="fcm-box" class="p-4 rounded-lg shadow-md text-center cursor-pointer" onclick="loadLineTickets('FCM')">
                    <h3 class="text-lg font-bold text-gray-800">FCM</h3>
                    <p class="text-gray-800 text-sm">Open: <span id="fcm-open">0</span></p>
                    <p class="text-gray-800 text-sm">Ongoing: <span id="fcm-ongoing">0</span></p>
                </div>
                <div id="mrr-box" class="p-4 rounded-lg shadow-md text-center cursor-pointer" onclick="loadLineTickets('MRR')">
                    <h3 class="text-lg font-bold text-gray-800">MRR</h3>
                    <p class="text-gray-800 text-sm">Open: <span id="mrr-open">0</span></p>
                    <p class="text-gray-800 text-sm">Ongoing: <span id="mrr-ongoing">0</span></p>
                </div>
                <div id="idb-box" class="p-4 rounded-lg shadow-md text-center cursor-pointer" onclick="loadLineTickets('IDB')">
                    <h3 class="text-lg font-bold text-gray-800">IDB</h3>
                    <p class="p-2 text-gray-800 text-sm">Open: <span id="idb-open">0</span></p>
                    <p class="p-2 text-gray-800 text-sm">Ongoing: <span id="idb-ongoing">0</span></p>
                </div>
                <div id="mgh-box" class="p-4 rounded-lg shadow-md text-center cursor-pointer" onclick="loadLineTickets('MGH')">
                    <h3 class="text-lg font-bold text-gray-800">MGH</h3>
                    <p class="p-2 text-gray-800 text-sm">Open: <span id="mgh-open">0</span></p>
                    <p class="p-2 text-gray-800 text-sm">Ongoing: <span id="mgh-ongoing">0</span></p>
                </div>
                <div id="ppk-box" class="p-4 rounded-lg shadow-md text-center cursor-pointer" onclick="loadLineTickets('PPK')">
                    <h3 class="text-lg font-bold text-gray-800">PPK</h3>
                    <p class="p-2 text-gray-800 text-sm">Open: <span id="ppk-open">0</span></p>
                    <p class="p-2 text-gray-800 text-sm">Ongoing: <span id="ppk-ongoing">0</span></p>
                </div>
                <div id="iamm-box" class="p-4 rounded-lg shadow-md text-center cursor-pointer" onclick="loadLineTickets('IAMM')">
                    <h3 class="text-lg font-bold text-gray-800">IAMM</h3>
                    <p class="p-2 text-gray-800 text-sm">Open: <span id="iamm-open">0</span></p>
                    <p class="p-2 text-gray-800 text-sm">Ongoing: <span id="iamm-ongoing">0</span></p>
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-4">
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h3 class="text-md font-semibold text-gray-800 mb-2">Tickets Generated Today (8AM - 8AM)</h3>
                    <p class="text-gray-700 text-sm" id="tickets-today">0</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h3 class="text-md font-semibold text-gray-800 mb-2">Tickets Generated This Week</h3>
                    <p class="text-gray-700 text-sm" id="tickets-week">0</p>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-md">
                <h3 class="text-md font-semibold text-gray-800 mb-2">Daily Downtime per Line (8AM - 8AM)</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg text-sm">
                        <thead>
                            <tr class="bg-gray-200">
                                <th class="p-2 text-left text-gray-700">Line</th>
                                <th class="p-2 text-left text-gray-700">Downtime (Minutes)</th>
                            </tr>
                        </thead>
                        <tbody id="downtime-table"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div id="all-tickets" class="screen hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">All Tickets</h2>
            <div class="mb-4">
                <label for="filter-status" class="block text-gray-700 font-medium text-sm">Filter by Status:</label>
                <select id="filter-status" onchange="loadAllTickets()" class="mt-1 p-2 w-full sm:w-48 border rounded focus:outline-none focus:ring-2 focus:ring-blue-600 text-sm">
                    <option value="">All</option>
                    <option value="Open">Open</option>
                    <option value="Ongoing">Ongoing</option>
                    <option value="Closed">Closed</option>
                </select>
            </div>
            <div class="overflow-y-auto max-h-96">
                <table class="min-w-full bg-white rounded-lg shadow-md text-sm">
                    <thead>
                        <tr class="bg-gray-200">
                            <th class="p-2 text-left text-gray-700">Ticket ID</th>
                            <th class="p-2 text-left text-gray-700">Employee ID</th>
                            <th class="p-2 text-left text-gray-700">Line</th>
                            <th class="p-2 text-left text-gray-700">Process</th>
                            <th class="p-2 text-left text-gray-700">Created At</th>
                            <th class="p-2 text-left text-gray-700">Description</th>
                            <th class="p-2 text-left text-gray-700">Status</th>
                        </tr>
                    </thead>
                    <tbody id="ticket-list"></tbody>
                </table>
            </div>
        </div>
        <div id="analytics" class="screen hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Analytics</h2>
            <div class="mb-4 flex flex-wrap gap-2">
                <div>
                    <label for="analytics-line" class="block text-gray-700 font-medium text-sm">Select Line:</label>
                    <select id="analytics-line" onchange="loadAnalytics()" class="mt-1 p-2 w-40 border rounded focus:outline-none focus:ring-2 focus:ring-blue-600 text-sm">
                        <option value="">Select Line</option>
                        <option value="MRR">MRR</option>
                        <option value="FCM">FCM</option>
                        <option value="IDB">IDB</option>
                        <option value="MGH">MGH</option>
                        <option value="PPK">PPK</option>
                        <option value="IAMM">IAMM</option>
                    </select>
                </div>
                <div>
                    <label for="analytics-type" class="block text-gray-700 font-medium text-sm">Select Chart Type:</label>
                    <select id="analytics-type" onchange="loadAnalytics()" class="mt-1 p-2 w-40 border rounded focus:outline-none focus:ring-2 focus:ring-blue-600 text-sm">
                        <option value="downtime">Downtime per Process</option>
                        <option value="tickets">Tickets per Process</option>
                    </select>
                </div>
                <div>
                    <label for="from-date" class="block text-gray-700 font-medium text-sm">From:</label>
                    <input type="date" id="from-date" onchange="loadAnalytics()" class="mt-1 p-2 w-40 border rounded focus:outline-none focus:ring-2 focus:ring-blue-600 text-sm">
                </div>
                <div>
                    <label for="to-date" class="block text-gray-700 font-medium text-sm">To:</label>
                    <input type="date" id="to-date" onchange="loadAnalytics()" class="mt-1 p-2 w-40 border rounded focus:outline-none focus:ring-2 focus:ring-blue-600 text-sm">
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-md mb-4">
                <canvas id="analytics-chart" height="200"></canvas>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-md max-w-md">
                <h3 class="text-md font-semibold text-gray-800 mb-2">Technician Performance</h3>
                <div class="overflow-x-auto">
                    <table class="w-full bg-white rounded-lg text-xs">
                        <thead>
                            <tr class="bg-gray-200">
                                <th class="p-2 text-left text-gray-700">Technician</th>
                                <th class="p-2 text-left text-gray-700">Resolved</th>
                                <th class="p-2 text-left text-gray-700">Resolve Time</th>
                                <th class="p-2 text-left text-gray-700">Downtime</th>
                            </tr>
                        </thead>
                        <tbody id="technician-table"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div id="login-modal" class="modal modal-front">
            <div class="modal-content">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Login</h2>
                <div class="mb-4">
                    <label for="login-email" class="block text-gray-700 font-medium text-sm">Email:</label>
                    <input type="email" id="login-email" class="mt-1 p-2 w-full border rounded focus:outline-none focus:ring-2 focus:ring-blue-600 text-sm" required>
                </div>
                <div class="mb-4">
                    <label for="login-password" class="block text-gray-700 font-medium text-sm">Password:</label>
                    <input type="password" id="login-password" class="mt-1 p-2 w-full border rounded focus:outline-none focus:ring-2 focus:ring-blue-600 text-sm" required>
                </div>
                <div class="mt-4 flex space-x-2">
                    <button onclick="login()" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">Login</button>
                    <button onclick="closeModal('login-modal')" class="px-3 py-1 bg-gray-600 text-white rounded hover:bg-gray-700 text-sm">Cancel</button>
                </div>
            </div>
        </div>
        <div id="ticket-details-modal" class="modal modal-front">
            <div class="modal-content">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Ticket Details</h2>
                <div id="ticket-details-content" class="text-gray-700 text-sm"></div>
                <button onclick="closeModal('ticket-details-modal')" class="mt-4 px-3 py-1 bg-gray-600 text-white rounded hover:bg-gray-700 text-sm">Close</button>
            </div>
        </div>
        <div id="assign-ticket-modal" class="modal modal-front">
            <div class="modal-content">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Assign Ticket</h2>
                <label for="technician-name" class="block text-gray-700 font-medium text-sm">Technician Name:</label>
                <select id="technician-name" class="mt-1 p-2 w-full border rounded focus:outline-none focus:ring-2 focus:ring-blue-600 text-sm" required>
                    <option value="">Select Technician</option>
                    <option value="Luis Martinez">Luis Martinez</option>
                    <option value="Luis Almanza">Luis Almanza</option>
                    <option value="Jose Olivo">Jose Olivo</option>
                    <option value="Manuel Linares">Manuel Linares</option>
                    <option value="Jonathan Oropeza">Jonathan Oropeza</option>
                    <option value="Angel Velasquez">Angel Velasquez</option>
                    <option value="Adolfo Hernandez">Adolfo Hernandez</option>
                    <option value="Pedro Mejia">Pedro Mejia</option>
                    <option value="Gerardo Martinez">Gerardo Martinez</option>
                    <option value="Jesus Estrada">Jesus Estrada</option>
                    <option value="Ramiro Perez">Ramiro Perez</option>
                    <option value="Brandon Cerecero">Brandon Cerecero</option>
                    <option value="Jaekyoung Lim">Jaekyoung Lim</option>
                    <option value="Angel Dario">Angel Dario</option>
                    <option value="Angel Gustavo">Angel Gustavo</option>
                    <option value="Daniel Venegas">Daniel Venegas</option>
                    <option value="David Fernandez">David Fernandez</option>
                    <option value="Juan Carrillo">Juan Carrillo</option>
                    <option value="Julio Mojica">Julio Mojica</option>
                    <option value="Issac Balderas">Issac Balderas</option>
                </select>
                <div class="mt-4 flex space-x-2">
                    <button onclick="assignTicket()" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">Assign</button>
                    <button onclick="closeModal('assign-ticket-modal')" class="px-3 py-1 bg-gray-600 text-white rounded hover:bg-gray-700 text-sm">Cancel</button>
                </div>
            </div>
        </div>
        <div id="resolve-ticket-modal" class="modal modal-front">
            <div class="modal-content">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Resolve Ticket</h2>
                <label for="issue" class="block text-gray-700 font-medium text-sm">Issue:</label>
                <textarea id="issue" class="mt-1 p-2 w-full border rounded focus:outline-none focus:ring-2 focus:ring-blue-600 text-sm h-20" required></textarea>
                <label for="fix" class="block text-gray-700 font-medium text-sm mt-2">Fix:</label>
                <textarea id="fix" class="mt-1 p-2 w-full border rounded focus:outline-none focus:ring-2 focus:ring-blue-600 text-sm h-20" required></textarea>
                <div class="mt-4 flex space-x-2">
                    <button onclick="resolveTicket()" class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm">Resolve Ticket</button>
                    <button onclick="closeModal('resolve-ticket-modal')" class="px-3 py-1 bg-gray-600 text-white rounded hover:bg-gray-700 text-sm">Cancel</button>
                </div>
            </div>
        </div>
        <div id="line-tickets-modal" class="modal">
            <div class="modal-content">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Tickets for <span id="line-title"></span></h2>
                <div id="line-tickets-content" class="space-y-4 text-sm"></div>
                <button onclick="closeModal('line-tickets-modal')" class="mt-4 px-3 py-1 bg-gray-600 text-white rounded hover:bg-gray-700 text-sm">Close</button>
            </div>
        </div>
        <script>
            const operationsByLine = {
                MRR: [
                    'Magazine Loading', 'Flash Programming', 'PCB Separation', 'ICT',
                    'Housing Loader', 'Tim Dispensing', 'PCB Assembly', 'Cavity Plate Seating',
                    'Screwing', 'Sealant Application', 'Radome Assembly', 'Curing',
                    'Leak Test', 'Calibration Loader', 'EOL', 'Labelling', 'Bracket Assembly',
                    'General Conveyors'
                ],
                FCM: [
                    'Magazine Loading', 'Flash Programming', 'PCB Separation', 'ICT',
                    'Conformal Coating', 'Coating Inspection', 'Palletizer', 'Module-Flex PCB Connect',
                    'Imager Module Screwing', 'ECU-Flex PCB Conect', 'TIM Dispensing',
                    'Lower Housing Screwing', 'Calibration Loader', 'Aging 1', 'Aging2',
                    'EOL Test', 'Labeling', 'Coupler Assembly', 'General Conveyors'
                ],
                IDB: [
                    'Magazine Loading', 'Fuse Bending', 'Flash Programming', 'ICT',
                    'Conformal Coating', 'Coating Inspection', 'PCB Separation', 'Press Fit (Main)',
                    'TIM dispensing', 'FIPG Dispensing', 'Dispensing Inspection', 'Cover Assembly',
                    'CIPG Dispensing', 'CIPG Inspection', 'Input Robot', 'Hot chamber',
                    'Output Robot', 'Hot Function Test', 'Cooling', 'Leak Test',
                    'Coil height & CIPG', 'Label', 'General Conveyors'
                ],
                MGH: [
                    'Magazine Loading', 'Flash Programming', 'PCB Separation', 'Fuse Bending',
                    'ICT', 'Conformal Coating', 'Coating Inspection', 'Curing',
                    'Press Fit (Main)', 'Vibration Welding', 'Vacuum Cleaner', 'Leak Test',
                    'Hot chamber', 'Hot Function Test', 'Cooling', 'Coil Height',
                    'Pin Check', 'Laser Marking', 'Packing', 'General Conveyors'
                ],
                IAMM: [
                    'Magazine Loading', 'Flash Programming', 'ICT', 'PCB Separation',
                    'Press Fit (PCB)', 'Press Fit (Coil)', 'Vibration Welding', 'Leak Test',
                    'EOL', 'Pin Check', 'Label', 'Packing', 'General Conveyors'
                ],
                PPK: [
                    'Magazine Loading', 'ICT/Flash Programing', 'PCB Separation', 'PCB Loading',
                    'Conformal Coating', 'Curing', 'Coating Inspection', 'Manual Insertion Components',
                    'Selective Soldering', 'XRAY', 'AOI', 'ECU Function Test', 'Packing',
                    'General Conveyors'
                ]
            };

            let currentUser = null;
            let accessToken = localStorage.getItem('accessToken') || null;
            let alarmInterval = null;
            let chartInstance = null;
            let isTestAlarmPlaying = false;
            let hasUserInteracted = false;
            let cachedTickets = [];
            let cachedStats = { today: 0, week: 0 };
            let cachedDowntime = [];
            let lastFetchFailed = false;

            window.addEventListener('load', () => {
                const overlay = document.createElement('div');
                overlay.style.position = 'fixed';
                overlay.style.top = '0';
                overlay.style.left = '0';
                overlay.style.width = '100%';
                overlay.style.height = '100%';
                overlay.style.background = 'rgba(0,0,0,0.5)';
                overlay.style.display = 'flex';
                overlay.style.alignItems = 'center';
                overlay.style.justifyContent = 'center';
                overlay.style.zIndex = '100';
                overlay.innerHTML = `
                    <div style="background: white; padding: 20px; border-radius: 8px; text-align: center;">
                        <p class="text-gray-800 mb-4">Click to enable audio alerts</p>
                        <button onclick="this.parentElement.parentElement.remove(); hasUserInteracted = true;" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Enable</button>
                    </div>
                `;
                document.body.appendChild(overlay);
            });

            function updateOperations() {
                const line = document.getElementById('line').value;
                const operationSelect = document.getElementById('operation');
                operationSelect.innerHTML = '<option value="">Select Operation</option>';
                if (line && operationsByLine[line]) {
                    operationsByLine[line].forEach(op => {
                        const option = document.createElement('option');
                        option.value = op;
                        option.textContent = op;
                        operationSelect.appendChild(option);
                    });
                }
            }

            function showScreen(screenId) {
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.add('hidden');
                });
                document.getElementById(screenId).classList.remove('hidden');
                if (screenId === 'dashboard') {
                    console.log('showScreen: Loading dashboard with fresh data');
                    fetchTicketData().then(() => loadDashboard());
                }
                if (screenId === 'all-tickets') loadAllTickets();
                if (screenId === 'analytics') loadAnalytics();
            }

            function refreshDashboard() {
                console.log('refreshDashboard: Forcing dashboard refresh');
                fetchTicketData().then(() => loadDashboard());
            }

            function showModal(modalId, ticketId = null, line = null) {
                console.log('showModal called with:', { modalId, ticketId, line });
                currentTicketId = ticketId;
                currentLine = line;
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'block';
                    if (modalId === 'ticket-details-modal' && ticketId) {
                        loadTicketDetails(ticketId);
                    }
                } else {
                    console.error(`Modal with ID ${modalId} not found`);
                    alert(`Error: Modal ${modalId} not found`);
                }
            }

            function closeModal(modalId) {
                console.log('closeModal called with:', { modalId });
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'none';
                } else {
                    console.error(`Modal with ID ${modalId} not found`);
                }
                document.getElementById('technician-name').value = '';
                document.getElementById('issue').value = '';
                document.getElementById('fix').value = '';
                document.getElementById('login-email').value = '';
                document.getElementById('login-password').value = '';
            }

            function showLoginModal() {
                showModal('login-modal');
            }

            async function login() {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                if (!email || !password) {
                    alert('Please enter email and password');
                    return;
                }
                try {
                    const response = await fetch('/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const { access_token, role } = await response.json();
                    accessToken = access_token;
                    localStorage.setItem('accessToken', accessToken);
                    currentUser = { role, email };
                    updateUIForRole();
                    closeModal('login-modal');
                    showScreen('dashboard');
                } catch (error) {
                    console.error('Error logging in:', error);
                    alert(`Failed to login: ${error.message}`);
                }
            }

            async function logout() {
                try {
                    const response = await fetch('/api/logout', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    accessToken = null;
                    localStorage.removeItem('accessToken');
                    currentUser = null;
                    updateUIForRole();
                    stopAlarm();
                    showScreen('dashboard');
                } catch (error) {
                    console.error('Error logging out:', error);
                    alert(`Failed to logout: ${error.message}`);
                }
            }

            function updateUIForRole() {
                const loginBtn = document.getElementById('login-btn');
                const logoutBtn = document.getElementById('logout-btn');
                const submitTicketBtn = document.getElementById('submit-ticket-btn');
                const dashboardBtn = document.getElementById('dashboard-btn');
                const allTicketsBtn = document.getElementById('all-tickets-btn');
                const analyticsBtn = document.getElementById('analytics-btn');
                const testAlarmBtn = document.getElementById('test-alarm-btn');
                const refreshBtn = document.getElementById('refresh-btn');
                const userRole = document.getElementById('user-role');

                if (!currentUser) {
                    loginBtn.classList.remove('hidden');
                    logoutBtn.classList.add('hidden');
                    submitTicketBtn.classList.add('hidden');
                    dashboardBtn.classList.add('hidden');
                    allTicketsBtn.classList.add('hidden');
                    analyticsBtn.classList.add('hidden');
                    testAlarmBtn.classList.add('hidden');
                    refreshBtn.classList.add('hidden');
                    userRole.textContent = 'Not logged in';
                    return;
                }

                loginBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                userRole.textContent = `Role: ${currentUser.role}`;
                submitTicketBtn.classList.remove('hidden');
                dashboardBtn.classList.remove('hidden');
                allTicketsBtn.classList.remove('hidden');
                analyticsBtn.classList.remove('hidden');
                refreshBtn.classList.remove('hidden');
                testAlarmBtn.classList.toggle('hidden', !['Manager', 'Maintenance Technician', 'Test Technician'].includes(currentUser.role));
            }

            let currentTicketId = null;
            let currentLine = null;

            async function submitTicket() {
                const employeeId = document.getElementById('employee-id').value;
                const name = document.getElementById('name').value;
                const line = document.getElementById('line').value;
                const process = document.getElementById('operation').value;
                const description = document.getElementById('description').value;

                if (!employeeId || !name || !line || !process || !description) {
                    alert('Please fill in all fields');
                    return;
                }

                try {
                    const response = await fetch('/api/tickets', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${accessToken}`
                        },
                        body: JSON.stringify({ employee_id: employeeId, name, line, process, description, status: 'Open' })
                    });
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }
                    document.getElementById('employee-id').value = '';
                    document.getElementById('name').value = '';
                    document.getElementById('line').value = '';
                    document.getElementById('operation').innerHTML = '<option value="">Select Operation</option>';
                    document.getElementById('description').value = '';
                    alert('Ticket submitted successfully');
                    await fetchTicketData();
                    showScreen('dashboard');
                } catch (error) {
                    console.error('Error submitting ticket:', error);
                    alert(`Failed to submit ticket: ${error.message}`);
                }
            }

            function startAlarm() {
                if (!hasUserInteracted && !isTestAlarmPlaying) {
                    console.log('Alarm blocked: No user interaction');
                    return;
                }
                const alarm = document.getElementById('alarm');
                alarm.play().catch(error => {
                    console.error('Error playing alarm:', error);
                    alert('Failed to play alarm. Ensure /beep-01a.mp3 is accessible.');
                });
            }

            function stopAlarm() {
                const alarm = document.getElementById('alarm');
                alarm.pause();
                alarm.currentTime = 0;
                isTestAlarmPlaying = false;
                if (alarmInterval) {
                    clearInterval(alarmInterval);
                    alarmInterval = null;
                }
            }

            function testAlarm() {
                const alarm = document.getElementById('alarm');
                const testAlarmBtn = document.getElementById('test-alarm-btn');
                if (isTestAlarmPlaying) {
                    stopAlarm();
                    testAlarmBtn.textContent = 'Test Alarm';
                } else {
                    alarm.play().catch(error => {
                        console.error('Error playing test alarm:', error);
                        alert('Failed to play alarm. Ensure /beep-01a.mp3 is accessible.');
                    });
                    isTestAlarmPlaying = true;
                    hasUserInteracted = true;
                    testAlarmBtn.textContent = 'Stop Alarm';
                }
            }

            async function fetchTicketData() {
                if (!accessToken) {
                    console.log('fetchTicketData: No access token, skipping');
                    lastFetchFailed = true;
                    return false;
                }
                for (let attempt = 1; attempt <= 3; attempt++) {
                    try {
                        console.log(`fetchTicketData: Attempt ${attempt} - Fetching tickets`);
                        const ticketUrl = `/api/tickets?t=${Date.now()}`;
                        console.log('fetchTicketData: Requesting', ticketUrl);
                        const ticketResponse = await fetch(ticketUrl, {
                            headers: { 
                                'Authorization': `Bearer ${accessToken}`,
                                'Cache-Control': 'no-cache'
                            }
                        });
                        if (!ticketResponse.ok) {
                            const errorText = await ticketResponse.text();
                            throw new Error(`HTTP ${ticketResponse.status}: ${errorText}`);
                        }
                        const tickets = await ticketResponse.json();
                        console.log('fetchTicketData: Tickets received', tickets.length, 'tickets');

                        console.log('fetchTicketData: Fetching stats');
                        const statsUrl = `/api/ticket-stats?t=${Date.now()}`;
                        const statsResponse = await fetch(statsUrl, {
                            headers: { 
                                'Authorization': `Bearer ${accessToken}`,
                                'Cache-Control': 'no-cache'
                            }
                        });
                        if (!statsResponse.ok) {
                            const errorText = await statsResponse.text();
                            throw new Error(`HTTP ${statsResponse.status}: ${errorText}`);
                        }
                        cachedStats = await statsResponse.json();
                        console.log('fetchTicketData: Stats received', cachedStats);

                        console.log('fetchTicketData: Fetching downtime');
                        const downtimeUrl = `/api/downtime?t=${Date.now()}`;
                        const downtimeResponse = await fetch(downtimeUrl, {
                            headers: { 
                                'Authorization': `Bearer ${accessToken}`,
                                'Cache-Control': 'no-cache'
                            }
                        });
                        if (!downtimeResponse.ok) {
                            const errorText = await downtimeResponse.text();
                            throw new Error(`HTTP ${downtimeResponse.status}: ${errorText}`);
                        }
                        cachedDowntime = await downtimeResponse.json();
                        console.log('fetchTicketData: Downtime received', cachedDowntime);

                        cachedTickets = tickets;
                        lastFetchFailed = false;
                        console.log('fetchTicketData: Completed successfully', { ticketCount: tickets.length });
                        return true;
                    } catch (error) {
                        console.error(`fetchTicketData: Attempt ${attempt} failed`, error);
                        if (attempt === 3) {
                            lastFetchFailed = true;
                            console.error('fetchTicketData: All attempts failed', error);
                            return false;
                        }
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
            }

            async function checkForAlarms() {
                if (!accessToken) {
                    console.log('checkForAlarms: No access token, skipping');
                    lastFetchFailed = true;
                    return;
                }
                try {
                    const success = await fetchTicketData();
                    if (!success) {
                        console.error('checkForAlarms: Fetch failed');
                        lastFetchFailed = true;
                        return;
                    }

                    const openTickets = cachedTickets.filter(t => t.status === 'Open');
                    console.log('checkForAlarms: Open tickets', openTickets.length);

                    const now = new Date();
                    const threeMinutesAgo = new Date(now.getTime() - 3 * 60 * 1000);
                    const overdueTickets = openTickets.filter(ticket => new Date(ticket.created_at) < threeMinutesAgo);
                    console.log('checkForAlarms: Overdue tickets', overdueTickets.length);

                    if (overdueTickets.length > 0 && !isTestAlarmPlaying) {
                        console.log('checkForAlarms: Starting alarm for overdue tickets');
                        startAlarm();
                    } else if (!isTestAlarmPlaying) {
                        console.log('checkForAlarms: Stopping alarm');
                        stopAlarm();
                    }

                    if (!document.getElementById('dashboard').classList.contains('hidden')) {
                        console.log('checkForAlarms: Dashboard is visible, updating');
                        loadDashboard();
                    } else {
                        console.log('checkForAlarms: Dashboard not visible, skipping update');
                    }
                } catch (error) {
                    console.error('checkForAlarms: Error', error);
                    lastFetchFailed = true;
                }
            }

            async function loadDashboard() {
                if (!accessToken) {
                    console.log('loadDashboard: No access token, skipping');
                    return;
                }
                try {
                    console.log('loadDashboard: Updating UI with cached data', {
                        ticketCount: cachedTickets.length,
                        stats: cachedStats,
                        downtimeLines: cachedDowntime.length
                    });
                    const tickets = cachedTickets;
                    const stats = cachedStats;
                    const downtimeData = cachedDowntime;

                    const lines = ['MRR', 'FCM', 'IDB', 'MGH', 'PPK', 'IAMM'];
                    lines.forEach(line => {
                        const openTickets = tickets.filter(t => t.line === line && t.status === 'Open').length;
                        const ongoingTickets = tickets.filter(t => t.line === line && t.status === 'Ongoing').length;
                        const box = document.getElementById(`${line.toLowerCase()}-box`);
                        box.classList.remove('flash-red', 'flash-yellow', 'bg-green-200');
                        if (openTickets > 0) {
                            box.classList.add('flash-red');
                        } else if (ongoingTickets > 0) {
                            box.classList.add('flash-yellow');
                        } else {
                            box.classList.add('bg-green-200');
                        }
                        document.getElementById(`${line.toLowerCase()}-open`).textContent = openTickets;
                        document.getElementById(`${line.toLowerCase()}-ongoing`).textContent = ongoingTickets;
                        console.log(`loadDashboard: Updated ${line} - Open: ${openTickets}, Ongoing: ${ongoingTickets}`);
                    });

                    document.getElementById('tickets-today').textContent = stats.today;
                    document.getElementById('tickets-week').textContent = stats.week;

                    const downtimeTable = document.getElementById('downtime-table');
                    downtimeTable.innerHTML = '';
                    downtimeData.forEach(({ line, downtime }) => {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-gray-50';
                        row.innerHTML = `
                            <td class="p-2">${line}</td>
                            <td class="p-2">${downtime}</td>
                        `;
                        downtimeTable.appendChild(row);
                    });
                    console.log('loadDashboard: UI update complete');
                } catch (error) {
                    console.error('loadDashboard: Error', error);
                    alert(`Failed to load dashboard: ${error.message}`);
                }
            }

            async function loadAllTickets() {
                const ticketList = document.getElementById('ticket-list');
                ticketList.innerHTML = '';
                try {
                    const filterStatus = document.getElementById('filter-status').value;
                    const baseUrl = '/api/tickets';
                    const queryParams = [];
                    if (filterStatus) queryParams.push(`status=${filterStatus}`);
                    queryParams.push(`t=${Date.now()}`);
                    const url = `${baseUrl}?${queryParams.join('&')}`;
                    console.log('loadAllTickets: Fetching tickets from', url);
                    const response = await fetch(url, {
                        headers: { 
                            'Authorization': `Bearer ${accessToken}`,
                            'Cache-Control': 'no-cache'
                        }
                    });
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP ${response.status}: ${errorText || 'Not Found'}`);
                    }
                    const tickets = await response.json();
                    console.log('loadAllTickets: Tickets received', tickets.length);
                    if (tickets.length === 0) {
                        ticketList.innerHTML = '<tr><td colspan="7" class="p-2 text-gray-600 text-center">No tickets found</td></tr>';
                        return;
                    }
                    tickets.forEach(ticket => {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-gray-50';
                        row.innerHTML = `
                            <td class="p-2"><a href="#" onclick="showModal('ticket-details-modal', '${ticket.ticket_id}')" class="text-blue-600 hover:underline">${ticket.ticket_id}</a></td>
                            <td class="p-2">${ticket.employee_id}</td>
                            <td class="p-2">${ticket.line}</td>
                            <td class="p-2">${ticket.process}</td>
                            <td class="p-2">${new Date(ticket.created_at).toLocaleString()}</td>
                            <td class="p-2">${ticket.description}</td>
                            <td class="p-2"><a href="#" onclick="handleStatusClick('${ticket.ticket_id}', '${ticket.status}')" class="text-blue-600 hover:underline">${ticket.status}</a></td>
                        `;
                        ticketList.appendChild(row);
                    });
                } catch (error) {
                    console.error('loadAllTickets: Error', error);
                    ticketList.innerHTML = '<tr><td colspan="7" class="p-2 text-red-600 text-center">Failed to load tickets: ' + error.message + '</td></tr>';
                    alert(`Failed to load tickets: ${error.message}`);
                }
            }

            async function loadTicketDetails(ticketId) {
                try {
                    const response = await fetch(`/api/tickets/${ticketId}?t=${Date.now()}`, {
                        headers: { 
                            'Authorization': `Bearer ${accessToken}`,
                            'Cache-Control': 'no-cache'
                        }
                    });
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const ticket = await response.json();
                    document.getElementById('ticket-details-content').innerHTML = `
                        <p class="mb-2"><strong>Ticket ID:</strong> ${ticket.ticket_id}</p>
                        <p class="mb-2"><strong>Employee ID:</strong> ${ticket.employee_id}</p>
                        <p class="mb-2"><strong>Name:</strong> ${ticket.name}</p>
                        <p class="mb-2"><strong>Line:</strong> ${ticket.line}</p>
                        <p class="mb-2"><strong>Process:</strong> ${ticket.process}</p>
                        <p class="mb-2"><strong>Created At:</strong> ${new Date(ticket.created_at).toLocaleString()}</p>
                        <p class="mb-2"><strong>Description:</strong> ${ticket.description}</p>
                        <p class="mb-2"><strong>Status:</strong> ${ticket.status}</p>
                        <p class="mb-2"><strong>Assigned To:</strong> ${ticket.assigned_to || 'Not assigned'}</p>
                        <p class="mb-2"><strong>Assigned At:</strong> ${ticket.assigned_at ? new Date(ticket.assigned_at).toLocaleString() : 'N/A'}</p>
                        <p class="mb-2"><strong>Resolved At:</strong> ${ticket.resolved_at ? new Date(ticket.resolved_at).toLocaleString() : 'N/A'}</p>
                        <p class="mb-2"><strong>Resolved By:</strong> ${ticket.resolved_by || 'N/A'}</p>
                        <p class="mb-2"><strong>Issue:</strong> ${ticket.issue || 'N/A'}</p>
                        <p class="mb-2"><strong>Fix:</strong> ${ticket.fix || 'N/A'}</p>
                    `;
                } catch (error) {
                    console.error('Error loading ticket details:', error);
                    alert(`Failed to load ticket details: ${error.message}`);
                }
            }

            async function loadLineTickets(line) {
                console.log('loadLineTickets called with:', { line });
                try {
                    const response = await fetch(`/api/tickets?status=Open,Ongoing&t=${Date.now()}`, {
                        headers: { 
                            'Authorization': `Bearer ${accessToken}`,
                            'Cache-Control': 'no-cache'
                        }
                    });
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const tickets = await response.json();
                    const lineTickets = tickets.filter(t => t.line === line && ['Open', 'Ongoing'].includes(t.status));
                    document.getElementById('line-title').textContent = line;
                    const content = document.getElementById('line-tickets-content');
                    content.innerHTML = '';
                    if (lineTickets.length === 0) {
                        content.innerHTML = '<p class="text-gray-600">No Open or Ongoing tickets for this line.</p>';
                    } else {
                        lineTickets.forEach(ticket => {
                            const ticketDiv = document.createElement('div');
                            ticketDiv.className = 'bg-white p-4 rounded-lg shadow-md mb-4';
                            let buttons = `
                                <button class="details-btn px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm" data-ticket-id="${ticket.ticket_id}">Details</button>
                            `;
                            if (['Manager', 'Maintenance Technician', 'Test Technician'].includes(currentUser?.role)) {
                                if (ticket.status === 'Open') {
                                    buttons += `<button class="assign-btn px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm" data-ticket-id="${ticket.ticket_id}" data-status="Open">Assign</button>`;
                                } else if (ticket.status === 'Ongoing') {
                                    buttons += `<button class="resolve-btn px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm" data-ticket-id="${ticket.ticket_id}" data-status="Ongoing">Resolve</button>`;
                                }
                            }
                            ticketDiv.innerHTML = `
                                <p class="font-semibold text-gray-800">${ticket.ticket_id} (Status: ${ticket.status})</p>
                                <p class="text-gray-600">Process: ${ticket.process}</p>
                                <p class="text-gray-600">Description: ${ticket.description}</p>
                                <p class="text-gray-600">Created: ${new Date(ticket.created_at).toLocaleString()}</p>
                                <div class="mt-2 flex space-x-2">${buttons}</div>
                            `;
                            content.appendChild(ticketDiv);
                        });
                    }
                    showModal('line-tickets-modal', null, line);
                    content.addEventListener('click', (event) => {
                        const target = event.target;
                        if (target.classList.contains('details-btn')) {
                            const ticketId = target.getAttribute('data-ticket-id');
                            console.log('Details button clicked:', { ticketId });
                            showModal('ticket-details-modal', ticketId);
                        } else if (target.classList.contains('assign-btn') && ['Manager', 'Maintenance Technician', 'Test Technician'].includes(currentUser?.role)) {
                            const ticketId = target.getAttribute('data-ticket-id');
                            const status = target.getAttribute('data-status');
                            console.log('Assign button clicked:', { ticketId, status });
                            handleStatusClick(ticketId, status);
                        } else if (target.classList.contains('resolve-btn') && ['Manager', 'Maintenance Technician', 'Test Technician'].includes(currentUser?.role)) {
                            const ticketId = target.getAttribute('data-ticket-id');
                            const status = target.getAttribute('data-status');
                            console.log('Resolve button clicked:', { ticketId, status });
                            handleStatusClick(ticketId, status);
                        }
                    });
                } catch (error) {
                    console.error('Error loading line tickets:', error);
                    alert(`Failed to load line tickets: ${error.message}`);
                }
            }

            function handleStatusClick(ticketId, status) {
                console.log('handleStatusClick called with:', { ticketId, status });
                if (!ticketId) {
                    console.error('No ticketId provided to handleStatusClick');
                    alert('Error: No ticket selected');
                    return;
                }
                currentTicketId = ticketId;
                console.log('Set currentTicketId:', currentTicketId);
                if (status === 'Open' && ['Manager', 'Maintenance Technician', 'Test Technician'].includes(currentUser?.role)) {
                    showModal('assign-ticket-modal', ticketId);
                } else if (status === 'Ongoing' && ['Manager', 'Maintenance Technician', 'Test Technician'].includes(currentUser?.role)) {
                    showModal('resolve-ticket-modal', ticketId);
                }
            }

            async function assignTicket() {
                const technicianName = document.getElementById('technician-name').value;
                if (!technicianName) {
                    alert('Please select a technician');
                    return;
                }
                if (!currentTicketId) {
                    console.error('No currentTicketId in assignTicket');
                    alert('Error: No ticket selected');
                    return;
                }
                console.log('Assigning ticket:', { ticketId: currentTicketId, technicianName });
                try {
                    const response = await fetch(`/api/tickets/${currentTicketId}/assign`, {
                        method: 'PUT',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${accessToken}`,
                            'Cache-Control': 'no-cache'
                        },
                        body: JSON.stringify({ assigned_to: technicianName, status: 'Ongoing', assigned_at: new Date().toISOString() })
                    });
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }
                    closeModal('assign-ticket-modal');
                    if (currentLine) loadLineTickets(currentLine);
                    loadAllTickets();
                    await fetchTicketData();
                    loadDashboard();
                    alert('Ticket assigned successfully');
                } catch (error) {
                    console.error('Error assigning ticket:', error);
                    alert(`Failed to assign ticket: ${error.message}`);
                }
            }

            async function resolveTicket() {
                const issue = document.getElementById('issue').value;
                const fix = document.getElementById('fix').value;
                if (!issue || !fix) {
                    alert('Please fill in issue and fix');
                    return;
                }
                if (!currentTicketId) {
                    console.error('No currentTicketId in resolveTicket');
                    alert('Error: No ticket selected');
                    return;
                }
                try {
                    const ticketResponse = await fetch(`/api/tickets/${currentTicketId}?t=${Date.now()}`, {
                        headers: { 
                            'Authorization': `Bearer ${accessToken}`,
                            'Cache-Control': 'no-cache'
                        }
                    });
                    if (!ticketResponse.ok) throw new Error(`HTTP ${ticketResponse.status}`);
                    const ticket = await ticketResponse.json();
                    const resolvedBy = ticket.assigned_to || 'Unknown';
                    console.log('Resolving ticket:', { ticketId: currentTicketId, issue, fix, resolvedBy });
                    const response = await fetch(`/api/tickets/${currentTicketId}/resolve`, {
                        method: 'PUT',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${accessToken}`,
                            'Cache-Control': 'no-cache'
                        },
                        body: JSON.stringify({ issue, fix, status: 'Closed', resolved_by: resolvedBy, resolved_at: new Date().toISOString() })
                    });
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }
                    closeModal('resolve-ticket-modal');
                    if (currentLine) loadLineTickets(currentLine);
                    loadAllTickets();
                    await fetchTicketData();
                    loadDashboard();
                    alert('Ticket resolved successfully');
                } catch (error) {
                    console.error('Error resolving ticket:', error);
                    alert(`Failed to resolve ticket: ${error.message}`);
                }
            }

            async function loadAnalytics() {
                try {
                    const line = document.getElementById('analytics-line').value;
                    const type = document.getElementById('analytics-type').value;
                    const fromDate = document.getElementById('from-date').value;
                    const toDate = document.getElementById('to-date').value;
                    if (!line || !type) return;

                    const baseUrl = `/api/${type === 'downtime' ? 'downtime-by-process' : 'tickets-by-process'}`;
                    const queryParams = [`line=${line}`, `t=${Date.now()}`];
                    if (fromDate) queryParams.push(`from=${fromDate}`);
                    if (toDate) queryParams.push(`to=${toDate}`);
                    const url = `${baseUrl}?${queryParams.join('&')}`;
                    console.log('loadAnalytics: Fetching from', url);
                    const response = await fetch(url, {
                        headers: { 
                            'Authorization': `Bearer ${accessToken}`,
                            'Cache-Control': 'no-cache'
                        }
                    });
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    let data = await response.json();
                    console.log('Analytics data:', data);

                    data = data.filter(item => (type === 'downtime' ? item.downtime : item.count) > 0)
                        .sort((a, b) => {
                            const valueA = type === 'downtime' ? a.downtime : a.count;
                            const valueB = type === 'downtime' ? b.downtime : b.count;
                            return valueB - valueA || a.process.localeCompare(b.process);
                        });

                    const labels = data.map(item => item.process);
                    const values = data.map(item => type === 'downtime' ? item.downtime : item.count);

                    if (chartInstance) chartInstance.destroy();
                    const ctx = document.getElementById('analytics-chart').getContext('2d');
                    chartInstance = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels,
                            datasets: [{
                                label: type === 'downtime' ? 'Downtime (Minutes)' : 'Tickets Created',
                                data: values,
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: type === 'downtime' ? 'Downtime (Minutes)' : 'Number of Tickets'
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Process'
                                    }
                                }
                            },
                            plugins: {
                                legend: { display: true },
                                title: {
                                    display: true,
                                    text: type === 'downtime' ? `Downtime per Process for ${line}` : `Tickets per Process for ${line}`
                                }
                            }
                        }
                    });

                    updateTechnicianTable();
                } catch (error) {
                    console.error('Error loading analytics:', error);
                    alert(`Failed to load analytics: ${error.message}`);
                }
            }

            async function updateTechnicianTable() {
                try {
                    const line = document.getElementById('analytics-line').value;
                    const fromDate = document.getElementById('from-date').value;
                    const toDate = document.getElementById('to-date').value;
                    const baseUrl = '/api/technician-stats';
                    const queryParams = [`t=${Date.now()}`];
                    if (line) queryParams.push(`line=${line}`);
                    if (fromDate) queryParams.push(`from=${fromDate}`);
                    if (toDate) queryParams.push(`to=${toDate}`);
                    const url = `${baseUrl}?${queryParams.join('&')}`;
                    console.log('updateTechnicianTable: Fetching from', url);
                    const response = await fetch(url, {
                        headers: { 
                            'Authorization': `Bearer ${accessToken}`,
                            'Cache-Control': 'no-cache'
                        }
                    });
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const data = await response.json();
                    console.log('Technician data:', data);
                    const tbody = document.getElementById('technician-table');
                    tbody.innerHTML = '';
                    data.forEach(item => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td class="p-2">${item.technician || 'Unassigned'}</td>
                            <td class="p-2">${item.tickets_resolved}</td>
                            <td class="p-2">${Math.round(item.total_resolve_time)}</td>
                            <td class="p-2">${Math.round(item.total_downtime)}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                    if (!data.length) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td class="p-2" colspan="4">No technician data available</td>`;
                        tbody.appendChild(tr);
                    }
                } catch (error) {
                    console.error('Error loading technician table:', error);
                    alert(`Failed to load technician data: ${error.message}`);
                }
            }

            async function init() {
                try {
                    if (accessToken) {
                        const response = await fetch(`/api/user?t=${Date.now()}`, {
                            headers: { 
                                'Authorization': `Bearer ${accessToken}`,
                                'Cache-Control': 'no-cache'
                            }
                        });
                        if (response.ok) {
                            const { role, email } = await response.json();
                            currentUser = { role, email };
                            await fetchTicketData();
                        }
                    }
                    updateUIForRole();
                    showScreen('dashboard');
                    if (!alarmInterval) {
                        console.log('init: Starting polling interval');
                        alarmInterval = setInterval(checkForAlarms, 3000);
                    }
                } catch (error) {
                    console.error('init: Error', error);
                    updateUIForRole();
                    showScreen('dashboard');
                }
            }

            init();
        </script>
    </body>
</html>